<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeumoCare Hospital Management System</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- REMOVED: Supabase SDK -->
    
    <style>
        /* ============ MEDICAL BLUE THEME ============ */
        :root {
            --medical-blue: #0077be;
            --medical-dark-blue: #005a9e;
            --medical-light-blue: #e3f2fd;
            --medical-teal: #00838f;
            --medical-green: #2e7d32;
            --medical-red: #c62828;
            --medical-orange: #f57c00;
            --medical-gray: #546e7a;
            --medical-light-gray: #f5f7fa;
            
            --primary-color: var(--medical-blue);
            --primary-dark: var(--medical-dark-blue);
            --primary-light: var(--medical-light-blue);
            --secondary-color: var(--medical-green);
            --danger-color: var(--medical-red);
            --warning-color: var(--medical-orange);
            --info-color: var(--medical-teal);
            --gray-50: #f8f9fa;
            --gray-100: #f1f3f4;
            --gray-200: #e8eaed;
            --gray-300: #dadce0;
            --gray-400: #bdc1c6;
            --gray-500: var(--medical-gray);
            --gray-600: #80868b;
            --gray-700: #5f6368;
            --gray-800: #3c4043;
            --gray-900: #202124;
            
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
            --shadow-xl: 0 20px 60px rgba(0,0,0,0.2);
            
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 16px;
            --border-radius-xl: 24px;
            
            --transition-fast: 150ms;
            --transition-normal: 250ms;
            --transition-slow: 350ms;
        }
        
        /* ADD THIS AT THE TOP OF YOUR STYLES */
        [v-cloak] {
            display: none !important;
        }

        #app[v-cloak] {
            opacity: 0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--gray-900);
            line-height: 1.6;
            min-height: 100vh;
            scroll-behavior: smooth;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            line-height: 1.3;
        }

        /* ============ UTILITY CLASSES ============ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .text-primary { color: var(--primary-color); }
        .text-success { color: var(--secondary-color); }
        .text-danger { color: var(--danger-color); }
        .text-warning { color: var(--warning-color); }
        .text-info { color: var(--info-color); }
        .text-muted { color: var(--gray-600); }

        .bg-primary { background: var(--primary-color); }
        .bg-success { background: var(--secondary-color); }
        .bg-danger { background: var(--danger-color); }
        .bg-warning { background: var(--warning-color); }
        .bg-info { background: var(--info-color); }
        .bg-light { background: var(--gray-50); }

        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }

        .rounded-sm { border-radius: var(--border-radius-sm); }
        .rounded-md { border-radius: var(--border-radius-md); }
        .rounded-lg { border-radius: var(--border-radius-lg); }
        .rounded-xl { border-radius: var(--border-radius-xl); }

        .transition { transition: all var(--transition-normal) ease; }
        .transition-fast { transition: all var(--transition-fast) ease; }
        .transition-slow { transition: all var(--transition-slow) ease; }

        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }

        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }

        .ml-2 { margin-left: 0.5rem; }

        .w-100 { width: 100%; }
        .h-100 { height: 100%; }

        .flex { display: flex; }
        .grid { display: grid; }
        .hidden { display: none; }
        .block { display: block; }

        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }

        /* ... (All other CSS styles remain exactly the same) ... */
        
        /* ============ RESPONSIVE ENHANCEMENTS ============ */
        @media (max-width: 768px) {
            .modal-container {
                width: 95%;
                margin: 10px;
            }
            
            .modal-xwide {
                max-width: 95%;
            }
            
            .staff-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .capacity-grid {
                grid-template-columns: 1fr;
            }
            
            .training-units-grid {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .grid.grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .modal-container {
                width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
            }
            
            .modal-overlay {
                padding: 0;
            }
            
            .modal-tabs {
                flex-wrap: wrap;
            }
            
            .modal-tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
                padding: 12px 8px;
                font-size: 12px;
            }
            
            .staff-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .staff-profile-header {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }
            
            .staff-basic-info {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>

        <!-- ============ TOAST CONTAINER ============ -->
        <div class="toast-container">
            <div v-for="toast in toasts" :key="toast.id" 
                 :class="['toast', `toast-${toast.type}`]" role="alert" aria-live="polite" aria-atomic="true">
                <div class="toast-icon">
                    <i :class="toast.icon"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">{{ toast.title }}</div>
                    <div class="toast-message">{{ toast.message }}</div>
                </div>
                <button class="toast-close" @click="removeToast(toast.id)" aria-label="Close notification">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- ============ LOGIN SCREEN ============ -->
        <div v-if="!currentUser" class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="login-logo">
                        <i class="fas fa-lungs"></i>
                        <span class="login-title">NeumoCare</span>
                    </div>
                    <p class="login-subtitle">Pulmonology Department Management System</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" v-model="loginForm.email" placeholder="admin@neumocare.org" aria-required="true">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" v-model="loginForm.password" placeholder="••••••••" aria-required="true">
                </div>
                
                <div class="form-group">
                    <label class="form-check">
                        <input type="checkbox" class="form-check-input" v-model="loginForm.remember_me">
                        <span class="form-check-label">Remember me</span>
                    </label>
                </div>
                
                <button class="btn btn-primary btn-lg w-100" @click="handleLogin" :disabled="loading" aria-label="Login to NeumoCare system">
                    <span v-if="loading" class="loading"></span>
                    <span v-else><i class="fas fa-sign-in-alt"></i> Login to NeumoCare</span>
                </button>
                
                <div class="text-center mt-4 text-muted">
                    <small>Demo Credentials: admin@neumocare.org / password123</small>
                </div>
            </div>
        </div>

        <!-- ============ MAIN APPLICATION ============ -->
        <div v-else class="app-layout">
            <!-- Sidebar -->
            <aside class="sidebar" :class="{ 'sidebar-collapsed': sidebarCollapsed, 'mobile-open': mobileMenuOpen }" 
                   aria-label="Main navigation">
                <div class="sidebar-header">
                    <div class="sidebar-logo">
                        <i class="fas fa-lungs"></i>
                        <span>NeumoCare</span>
                    </div>
                    <button class="sidebar-toggle" @click="sidebarCollapsed = !sidebarCollapsed" aria-label="Toggle sidebar">
                        <i class="fas" :class="sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
                    </button>
                </div>
                
                <nav class="sidebar-nav" aria-label="Primary navigation">
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">Dashboard</div>
                        <ul class="sidebar-menu">
                            <li class="sidebar-menu-item">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'daily_operations' }" 
                                   @click.prevent="switchView('daily_operations'); mobileMenuOpen = false"
                                   aria-label="Dashboard overview" :aria-current="currentView === 'daily_operations' ? 'page' : null">
                                    <i class="fas fa-tachometer-alt"></i>
                                    <span>Overview</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">Clinical Operations</div>
                        <ul class="sidebar-menu">
                            <li class="sidebar-menu-item">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'medical_staff' }" 
                                   @click.prevent="switchView('medical_staff'); mobileMenuOpen = false" v-if="hasPermission('medical_staff', 'read')"
                                   :aria-current="currentView === 'medical_staff' ? 'page' : null">
                                    <i class="fas fa-user-md"></i>
                                    <span>Medical Staff</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'patient_census' }" 
                                   @click.prevent="switchView('patient_census'); mobileMenuOpen = false" v-if="hasPermission('patient_census', 'read')"
                                   :aria-current="currentView === 'patient_census' ? 'page' : null">
                                    <i class="fas fa-procedures"></i>
                                    <span>Patient Census</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'oncall_schedule' }" 
                                   @click.prevent="switchView('oncall_schedule'); mobileMenuOpen = false" v-if="hasPermission('oncall_schedule', 'read')"
                                   :aria-current="currentView === 'oncall_schedule' ? 'page' : null">
                                    <i class="fas fa-phone-alt"></i>
                                    <span>On-call Schedule</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">Training & Education</div>
                        <ul class="sidebar-menu">
                            <li class="sidebar-menu-item">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'resident_rotations' }" 
                                   @click.prevent="switchView('resident_rotations'); mobileMenuOpen = false" v-if="hasPermission('resident_rotations', 'read')"
                                   :aria-current="currentView === 'resident_rotations' ? 'page' : null">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Resident Rotations</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'training_units' }" 
                                   @click.prevent="switchView('training_units'); mobileMenuOpen = false" v-if="hasPermission('training_units', 'read')"
                                   :aria-current="currentView === 'training_units' ? 'page' : null">
                                    <i class="fas fa-clinic-medical"></i>
                                    <span>Training Units</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">Administration</div>
                        <ul class="sidebar-menu">
                            <li class="sidebar-menu-item">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'staff_absence' }" 
                                   @click.prevent="switchView('staff_absence'); mobileMenuOpen = false" v-if="hasPermission('staff_absence', 'read')"
                                   :aria-current="currentView === 'staff_absence' ? 'page' : null">
                                    <i class="fas fa-calendar-times"></i>
                                    <span>Staff Absence</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'department_management' }" 
                                   @click.prevent="switchView('department_management'); mobileMenuOpen = false" v-if="hasPermission('system', 'manage_departments')"
                                   :aria-current="currentView === 'department_management' ? 'page' : null">
                                    <i class="fas fa-sitemap"></i>
                                    <span>Departments</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'communications' }" 
                                   @click.prevent="switchView('communications'); mobileMenuOpen = false" v-if="hasPermission('communications', 'read')"
                                   :aria-current="currentView === 'communications' ? 'page' : null">
                                    <i class="fas fa-bullhorn"></i>
                                    <span>Communications</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item" v-if="hasPermission('audit', 'read')">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'audit_logs' }" 
                                   @click.prevent="switchView('audit_logs'); mobileMenuOpen = false"
                                   :aria-current="currentView === 'audit_logs' ? 'page' : null">
                                    <i class="fas fa-history"></i>
                                    <span>Audit Logs</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item" v-if="hasPermission('permissions', 'manage')">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'permission_manager' }" 
                                   @click.prevent="switchView('permission_manager'); mobileMenuOpen = false"
                                   :aria-current="currentView === 'permission_manager' ? 'page' : null">
                                    <i class="fas fa-user-shield"></i>
                                    <span>Permission Manager</span>
                                </a>
                            </li>
                            <li class="sidebar-menu-item" v-if="hasPermission('system', 'read')">
                                <a href="#" class="sidebar-menu-link" :class="{ active: currentView === 'system_settings' }" 
                                   @click.prevent="switchView('system_settings'); mobileMenuOpen = false"
                                   :aria-current="currentView === 'system_settings' ? 'page' : null">
                                    <i class="fas fa-cog"></i>
                                    <span>System Settings</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>
                
                <div class="sidebar-footer">
                    <div class="sidebar-user">
                        <div class="user-avatar" aria-hidden="true">{{ getInitials(currentUser.full_name) }}</div>
                        <div class="user-info">
                            <div class="user-name">{{ currentUser.full_name }}</div>
                            <div class="user-role">{{ getUserRoleDisplay(currentUser.user_role) }}</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Quick Stats Sidebar -->
            <button class="stats-toggle-btn" @click="toggleStatsSidebar" :aria-label="statsSidebarOpen ? 'Close statistics sidebar' : 'Open statistics sidebar'">
                <i class="fas" :class="statsSidebarOpen ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
            </button>
            
            <div class="quick-stats-sidebar" :class="{ open: statsSidebarOpen }" role="complementary" aria-label="Live statistics">
                <div class="stats-header">
                    <div class="stats-title">
                        <i class="fas fa-chart-line"></i>
                        Live Statistics
                    </div>
                    <button class="stats-close" @click="statsSidebarOpen = false" aria-label="Close statistics">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">Department Occupancy</span>
                    <div v-if="loadingStats" class="skeleton skeleton-text" style="width: 60px;"></div>
                    <template v-else>
                        <span class="stat-value">{{ liveStats.occupancy || 0 }}%</span>
                        <span class="stat-trend" :class="liveStats.occupancyTrend > 0 ? 'positive' : 'negative'">
                            {{ liveStats.occupancyTrend > 0 ? '↑' : '↓' }}{{ Math.abs(liveStats.occupancyTrend || 0) }}%
                        </span>
                    </template>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">On-duty Staff</span>
                    <div v-if="loadingStats" class="skeleton skeleton-text" style="width: 40px;"></div>
                    <template v-else>
                        <span class="stat-value">{{ liveStats.onDutyStaff || 0 }}</span>
                        <span class="stat-trend" :class="liveStats.staffTrend > 0 ? 'positive' : 'negative'">
                            {{ liveStats.staffTrend > 0 ? '↑' : '↓' }}{{ Math.abs(liveStats.staffTrend || 0) }}
                        </span>
                    </template>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">Pending Requests</span>
                    <div v-if="loadingStats" class="skeleton skeleton-text" style="width: 30px;"></div>
                    <template v-else>
                        <span class="stat-value">{{ liveStats.pendingRequests || 0 }}</span>
                    </template>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">ER Capacity</span>
                    <div v-if="loadingStats" class="skeleton skeleton-text" style="width: 80px;"></div>
                    <template v-else>
                        <span class="stat-value">{{ liveStats.erCapacity?.current || 0 }}/{{ liveStats.erCapacity?.max || 0 }}</span>
                        <span class="stat-trend" :class="liveStats.erCapacity?.status || ''">{{ liveStats.erCapacity?.status || 'normal' }}</span>
                    </template>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">ICU Capacity</span>
                    <div v-if="loadingStats" class="skeleton skeleton-text" style="width: 80px;"></div>
                    <template v-else>
                        <span class="stat-value">{{ liveStats.icuCapacity?.current || 0 }}/{{ liveStats.icuCapacity?.max || 0 }}</span>
                        <span class="stat-trend" :class="liveStats.icuCapacity?.status || ''">{{ liveStats.icuCapacity?.status || 'normal' }}</span>
                    </template>
                </div>
            </div>

            <!-- Main Content -->
            <main class="main-content" :class="{ 'main-content-expanded': sidebarCollapsed }">
                <!-- Top Navbar -->
                <header class="top-navbar">
                    <div class="navbar-left">
                        <button class="mobile-menu-toggle" @click="mobileMenuOpen = !mobileMenuOpen" aria-label="Toggle mobile menu">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <span class="navbar-title">{{ getCurrentTitle() }}</span>
                            <span class="navbar-subtitle">{{ getCurrentSubtitle() }}</span>
                        </div>
                    </div>
                    
                    <div class="navbar-right">
                        <!-- Enhanced Search -->
                        <div class="search-container">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" :placeholder="getSearchPlaceholder()" 
                                       v-model="searchQuery" @keyup.enter="handleSearch"
                                       aria-label="Search">
                                <button class="search-scope" @click="toggleSearchScope" aria-label="Change search scope">
                                    {{ searchScope }} <i class="fas fa-chevron-down ml-2"></i>
                                </button>
                            </div>
                            
                            <div class="search-filters">
                                <button class="search-filter-btn" :class="{ active: searchFilter === 'all' }" 
                                        @click="setSearchFilter('all')">All</button>
                                <button class="search-filter-btn" :class="{ active: searchFilter === 'staff' }" 
                                        @click="setSearchFilter('staff')">Staff</button>
                                <button class="search-filter-btn" :class="{ active: searchFilter === 'patients' }" 
                                        @click="setSearchFilter('patients')">Patients</button>
                                <button class="search-filter-btn" :class="{ active: searchFilter === 'units' }" 
                                        @click="setSearchFilter('units')">Units</button>
                            </div>
                        </div>
                        
                        <div class="navbar-actions" style="display: flex; align-items: center; gap: 12px;">
                            <div class="notification-badge">
                                <button class="btn btn-icon btn-secondary" @click="showNotifications" 
                                        :aria-label="`${unreadNotifications} unread notifications`">
                                    <i class="fas fa-bell"></i>
                                    <span class="badge badge-danger" v-if="unreadNotifications > 0" style="position: absolute; top: -8px; right: -8px; min-width: 20px; height: 20px; padding: 2px 6px; font-size: 10px;">
                                        {{ unreadNotifications }}
                                    </span>
                                </button>
                            </div>
                            
                            <button class="btn btn-icon btn-secondary" @click="showCommunicationsModal" 
                                    v-if="hasPermission('communications', 'create')" aria-label="Communications">
                                <i class="fas fa-bullhorn"></i>
                            </button>
                            
                            <div class="user-menu" style="position: relative;">
                                <button class="user-menu-toggle" @click="toggleUserMenu" :aria-label="`${currentUser.full_name} profile menu`" style="display: flex; align-items: center; gap: 8px; background: none; border: none; cursor: pointer; padding: 8px; border-radius: var(--border-radius-md); transition: background var(--transition-fast); min-height: 44px;">
                                    <div class="user-avatar">{{ getInitials(currentUser.full_name) }}</div>
                                    <i class="fas fa-chevron-down" style="font-size: 12px;"></i>
                                </button>
                                
                                <div class="action-menu" v-if="userMenuOpen" style="position: absolute; right: 0; top: 100%; margin-top: 8px; min-width: 200px;">
                                    <div class="action-menu-item" @click="showUserProfile">
                                        <i class="fas fa-user"></i>
                                        <span>Profile Settings</span>
                                    </div>
                                    <div class="action-menu-item" @click="showSystemSettingsModal" v-if="hasPermission('system', 'read')">
                                        <i class="fas fa-cog"></i>
                                        <span>System Settings</span>
                                    </div>
                                    <div class="action-menu-item" @click="showPermissionManager" v-if="hasPermission('permissions', 'manage')">
                                        <i class="fas fa-user-shield"></i>
                                        <span>Permission Manager</span>
                                    </div>
                                    <div class="action-menu-item danger" @click="handleLogout">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Content Area -->
                <div class="content-area">
                    <!-- Dynamic Alert Banner -->
                    <div v-if="activeAlerts.length > 0" class="alert-banner">
                        <div class="alert-banner-content">
                            <i class="fas fa-exclamation-triangle alert-banner-icon"></i>
                            <span class="alert-banner-message">
                                {{ activeAlerts[0].message }}
                                <span v-if="activeAlerts.length > 1"> (and {{ activeAlerts.length - 1 }} more)</span>
                            </span>
                        </div>
                        <button class="alert-banner-close" @click="dismissAlert(activeAlerts[0].id)" aria-label="Dismiss alert">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Breadcrumb Navigation -->
                    <nav class="breadcrumb" style="display: flex; align-items: center; gap: 8px; margin-bottom: 24px; padding: 12px 0; border-bottom: 2px solid var(--medical-light-blue); flex-wrap: wrap;" aria-label="Breadcrumb">
                        <div class="breadcrumb-item" @click="switchView('daily_operations')" style="cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--medical-gray); font-size: 14px; transition: color var(--transition-fast); text-decoration: none; padding: 4px 8px; border-radius: 4px;">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </div>
                        <div class="breadcrumb-separator" style="color: var(--gray-400);">/</div>
                        <div class="breadcrumb-item active" style="display: flex; align-items: center; gap: 8px; color: var(--medical-blue); font-size: 14px; font-weight: 500; padding: 4px 8px;" aria-current="page">
                            {{ getCurrentTitle() }}
                        </div>
                    </nav>

                    <!-- Daily Operations View -->
                    <div v-if="currentView === 'daily_operations'">
                        <!-- Quick Actions -->
                        <div class="quick-actions">
                            <div class="quick-action-btn" @click="showAddMedicalStaffModal" v-if="hasPermission('medical_staff', 'create')">
                                <i class="fas fa-user-plus" style="color: var(--medical-green);"></i>
                                Add Medical Staff
                            </div>
                            <div class="quick-action-btn" @click="showAddOnCallModal" v-if="hasPermission('oncall_schedule', 'create')">
                                <i class="fas fa-phone-alt" style="color: var(--medical-blue);"></i>
                                Schedule On-call
                            </div>
                            <div class="quick-action-btn" @click="showAddAbsenceModal" v-if="hasPermission('staff_absence', 'create')">
                                <i class="fas fa-calendar-times" style="color: var(--medical-orange);"></i>
                                Document Absence
                            </div>
                            <div class="quick-action-btn" @click="showQuickPlacementModal" v-if="hasPermission('placements', 'create')">
                                <i class="fas fa-user-md" style="color: var(--medical-teal);"></i>
                                Quick Placement
                            </div>
                            <div class="quick-action-btn" @click="showAddRotationModal" v-if="hasPermission('resident_rotations', 'create')">
                                <i class="fas fa-calendar-alt" style="color: var(--medical-blue);"></i>
                                Add Rotation
                            </div>
                            <div class="quick-action-btn" @click="showCommunicationsModal" v-if="hasPermission('communications', 'create')">
                                <i class="fas fa-bullhorn" style="color: var(--medical-red);"></i>
                                Post Announcement
                            </div>
                        </div>

                        <!-- Stats Overview -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon primary">
                                    <i class="fas fa-user-md"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value">
                                        <span v-if="loadingStats" class="skeleton skeleton-text" style="width: 60px; display: inline-block;"></span>
                                        <span v-else>{{ stats.totalStaff || 0 }}</span>
                                    </div>
                                    <div class="stat-label">Total Medical Staff</div>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon success">
                                    <i class="fas fa-procedures"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value">
                                        <span v-if="loadingStats" class="skeleton skeleton-text" style="width: 60px; display: inline-block;"></span>
                                        <span v-else>{{ stats.activePatients || 0 }}</span>
                                    </div>
                                    <div class="stat-label">Active Patients</div>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon warning">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value">
                                        <span v-if="loadingStats" class="skeleton skeleton-text" style="width: 60px; display: inline-block;"></span>
                                        <span v-else>{{ stats.todayAppointments || 0 }}</span>
                                    </div>
                                    <div class="stat-label">Today's Appointments</div>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value">
                                        <span v-if="loadingStats" class="skeleton skeleton-text" style="width: 60px; display: inline-block;"></span>
                                        <span v-else>{{ stats.pendingAlerts || 0 }}</span>
                                    </div>
                                    <div class="stat-label">Pending Alerts</div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Announcements -->
                        <div class="card mb-6">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-bullhorn"></i>
                                    Recent Announcements
                                </div>
                                <button class="btn btn-sm btn-primary" @click="showCommunicationsModal" v-if="hasPermission('communications', 'create')">
                                    <i class="fas fa-plus"></i> New Announcement
                                </button>
                            </div>
                            <div class="card-content">
                                <div v-if="loadingAnnouncements" class="loading-overlay">
                                    <div class="loading-spinner"></div>
                                </div>
                                <div v-else-if="recentAnnouncements.length === 0" class="empty-state">
                                    <i class="fas fa-bullhorn empty-state-icon"></i>
                                    <div class="empty-state-title">No Announcements</div>
                                    <div class="empty-state-description">
                                        No announcements have been posted yet.
                                    </div>
                                    <button class="btn btn-primary mt-4" @click="showCommunicationsModal" v-if="hasPermission('communications', 'create')">
                                        <i class="fas fa-plus"></i> Create Announcement
                                    </button>
                                </div>
                                <div v-else>
                                    <div v-for="announcement in recentAnnouncements.slice(0, 3)" :key="announcement.id" style="margin-bottom: 16px; padding: 16px; border: 1px solid var(--medical-light-blue); border-radius: var(--border-radius-md); transition: all var(--transition-fast);" @mouseenter="this.style.backgroundColor='var(--medical-light-blue)'" @mouseleave="this.style.backgroundColor='white'">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                            <div>
                                                <div style="font-weight: 600; color: var(--medical-dark-blue);">{{ announcement.title }}</div>
                                                <div style="font-size: 12px; color: var(--medical-gray);">By: {{ announcement.author }} • {{ formatTimeAgo(announcement.created_at) }}</div>
                                            </div>
                                            <span class="badge" :class="`badge-${announcement.priority}`">
                                                {{ announcement.priority }}
                                            </span>
                                        </div>
                                        <p style="color: var(--gray-700); margin-bottom: 12px;">{{ announcement.content }}</p>
                                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--gray-500);">
                                            <span>Expires: {{ announcement.expires_at ? formatDateTime(announcement.expires_at) : 'Never' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Today's On-call Schedule -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-phone-alt"></i>
                                    Today's On-call Schedule
                                </div>
                                <button class="btn btn-sm btn-primary" @click="showAddOnCallModal" v-if="hasPermission('oncall_schedule', 'create')">
                                    <i class="fas fa-plus"></i> Add Schedule
                                </button>
                            </div>
                            <div class="card-content">
                                <div v-if="loadingSchedule" class="loading-overlay">
                                    <div class="loading-spinner"></div>
                                </div>
                                <div v-else-if="todaysOnCall.length === 0" class="empty-state">
                                    <i class="fas fa-phone-slash empty-state-icon"></i>
                                    <div class="empty-state-title">No On-call Scheduled</div>
                                    <div class="empty-state-description">
                                        No physicians are scheduled for on-call duty today
                                    </div>
                                    <button class="btn btn-primary mt-4" @click="showAddOnCallModal" v-if="hasPermission('oncall_schedule', 'create')">
                                        <i class="fas fa-plus"></i> Schedule On-call
                                    </button>
                                </div>
                                <div v-else class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Physician</th>
                                                <th>Shift Time</th>
                                                <th>Role</th>
                                                <th>Contact</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="schedule in todaysOnCall" :key="schedule.id">
                                                <td>{{ schedule.physician_name }}</td>
                                                <td>{{ formatTimeRange(schedule.start_time, schedule.end_time) }}</td>
                                                <td>
                                                    <span class="badge badge-primary">{{ schedule.role }}</span>
                                                </td>
                                                <td>{{ schedule.contact_number || 'N/A' }}</td>
                                                <td>
                                                    <div class="action-dropdown">
                                                        <button class="btn btn-sm btn-secondary" @click="toggleActionMenu($event)" aria-label="Schedule actions">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        <div class="action-menu">
                                                            <div class="action-menu-item" @click="editOnCallSchedule(schedule)" v-if="hasPermission('oncall_schedule', 'update')">
                                                                <i class="fas fa-edit"></i>
                                                                <span>Edit</span>
                                                            </div>
                                                            <div class="action-menu-item danger" @click="deleteOnCallSchedule(schedule.id)" v-if="hasPermission('oncall_schedule', 'delete')">
                                                                <i class="fas fa-trash"></i>
                                                                <span>Delete</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Medical Staff View -->
                    <div v-if="currentView === 'medical_staff'">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <div>
                                <h2 class="section-title" style="font-size: 24px; font-weight: 600; color: var(--medical-dark-blue);">Medical Staff Management</h2>
                                <p class="text-muted" style="color: var(--medical-gray);">Manage all medical staff with comprehensive profiles</p>
                            </div>
                            <button class="btn btn-primary" @click="showAddMedicalStaffModal" 
                                    v-if="hasPermission('medical_staff', 'create')">
                                <i class="fas fa-plus"></i> Add Medical Staff
                            </button>
                        </div>

                        <!-- Filters -->
                        <div class="filter-bar" style="display: flex; gap: 12px; align-items: center; padding: 16px; background: white; border-radius: var(--border-radius-md); margin-bottom: 20px; flex-wrap: wrap; border: 1px solid var(--medical-light-blue);">
                            <div class="filter-group" style="display: flex; flex-direction: column; gap: 4px; min-width: 180px; flex: 1;">
                                <div class="filter-label" style="font-size: 12px; color: var(--medical-gray); font-weight: 500;">Search</div>
                                <input type="text" class="form-control form-control-sm" v-model="staffSearch" placeholder="Name, ID, or email...">
                            </div>
                            <div class="filter-group" style="display: flex; flex-direction: column; gap: 4px; min-width: 180px; flex: 1;">
                                <div class="filter-label" style="font-size: 12px; color: var(--medical-gray); font-weight: 500;">Staff Type</div>
                                <select class="form-select form-select-sm" v-model="staffFilter.staff_type">
                                    <option value="">All Types</option>
                                    <option value="medical_resident">Medical Resident</option>
                                    <option value="attending_physician">Attending Physician</option>
                                    <option value="fellow">Fellow</option>
                                    <option value="nurse_practitioner">Nurse Practitioner</option>
                                </select>
                            </div>
                            <div class="filter-group" style="display: flex; flex-direction: column; gap: 4px; min-width: 180px; flex: 1;">
                                <div class="filter-label" style="font-size: 12px; color: var(--medical-gray); font-weight: 500;">Status</div>
                                <select class="form-select form-select-sm" v-model="staffFilter.employment_status">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="on_leave">On Leave</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="filter-actions" style="display: flex; gap: 8px; margin-left: auto;">
                                <button class="btn btn-sm btn-secondary" @click="resetStaffFilters">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                                <button class="btn btn-sm btn-primary" @click="applyStaffFilters">
                                    <i class="fas fa-filter"></i> Apply
                                </button>
                            </div>
                        </div>

                        <!-- Staff Table -->
                        <div class="card">
                            <div v-if="loadingStaff" class="loading-overlay">
                                <div class="loading-spinner"></div>
                            </div>
                            <div v-else-if="filteredMedicalStaff.length === 0" class="empty-state">
                                <i class="fas fa-user-md empty-state-icon"></i>
                                <div class="empty-state-title">No Medical Staff Found</div>
                                <div class="empty-state-description">
                                    Try adjusting your filters or add new medical staff to get started.
                                </div>
                                <button class="btn btn-primary mt-4" @click="showAddMedicalStaffModal" v-if="hasPermission('medical_staff', 'create')">
                                    <i class="fas fa-plus"></i> Add Medical Staff
                                </button>
                            </div>
                            <div v-else class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Staff Type</th>
                                            <th>Staff ID</th>
                                            <th>Department</th>
                                            <th>Status</th>
                                            <th>Last Active</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="staff in filteredMedicalStaff" :key="staff.id">
                                            <td style="cursor: pointer;" @click="viewStaffDetails(staff)">
                                                <div class="flex items-center gap-3" style="display: flex; align-items: center; gap: 12px;">
                                                    <div class="user-avatar" aria-hidden="true">{{ getInitials(staff.full_name) }}</div>
                                                    <div>
                                                        <div class="font-medium" style="font-weight: 500; color: var(--medical-dark-blue);">{{ staff.full_name }}</div>
                                                        <div class="text-sm text-gray-500">{{ staff.professional_email }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge" :class="getStaffTypeClass(staff.staff_type)">
                                                    {{ formatStaffType(staff.staff_type) }}
                                                </span>
                                            </td>
                                            <td>{{ staff.staff_id }}</td>
                                            <td>{{ getDepartmentName(staff.department_id) || 'Unassigned' }}</td>
                                            <td>
                                                <span class="badge" :class="staff.employment_status === 'active' ? 'status-available' : staff.employment_status === 'on_leave' ? 'status-busy' : 'status-critical'">
                                                    {{ formatEmploymentStatus(staff.employment_status) }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="updated-timestamp" style="font-size: 12px; color: var(--medical-gray); display: flex; align-items: center; gap: 4px;">
                                                    <i class="fas fa-clock"></i> {{ formatTimeAgo(staff.last_activity) }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="action-dropdown">
                                                    <button class="btn btn-sm btn-secondary" @click="toggleActionMenu($event)" aria-label="Staff actions">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <div class="action-menu">
                                                        <div class="action-menu-item" @click="viewStaffDetails(staff)">
                                                            <i class="fas fa-eye"></i>
                                                            <span>View Profile</span>
                                                        </div>
                                                        <div class="action-menu-item" @click="editMedicalStaff(staff)" v-if="hasPermission('medical_staff', 'update')">
                                                            <i class="fas fa-edit"></i>
                                                            <span>Edit</span>
                                                        </div>
                                                        <div class="action-menu-item" @click="assignRotationToStaff(staff)" v-if="hasPermission('resident_rotations', 'create') && staff.staff_type === 'medical_resident'">
                                                            <i class="fas fa-calendar-alt"></i>
                                                            <span>Assign Rotation</span>
                                                        </div>
                                                        <div class="action-menu-item danger" @click="deleteMedicalStaff(staff.id)" v-if="hasPermission('medical_staff', 'delete')">
                                                            <i class="fas fa-trash"></i>
                                                            <span>Delete</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Department Management View -->
                    <div v-if="currentView === 'department_management'">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <div>
                                <h2 class="section-title" style="font-size: 24px; font-weight: 600; color: var(--medical-dark-blue);">Department Management</h2>
                                <p class="text-muted" style="color: var(--medical-gray);">Manage departments and clinical units for organizational structure</p>
                            </div>
                            <div class="flex gap-2" style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" @click="showAddDepartmentModal" 
                                        v-if="hasPermission('system', 'manage_departments')">
                                    <i class="fas fa-plus"></i> Add Department
                                </button>
                                <button class="btn btn-success" @click="showAddClinicalUnitModal" 
                                        v-if="hasPermission('system', 'manage_departments')">
                                    <i class="fas fa-plus"></i> Add Clinical Unit
                                </button>
                            </div>
                        </div>

                        <!-- Departments Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 32px;">
                            <div v-for="department in departments" :key="department.id" class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-hospital"></i>
                                        {{ department.name }}
                                    </div>
                                    <span class="badge" :class="department.status === 'active' ? 'status-available' : 'status-busy'">
                                        {{ department.status }}
                                    </span>
                                </div>
                                
                                <div class="mb-4">
                                    <div class="text-sm text-gray-600 mb-2">Department Code: {{ department.code }}</div>
                                    <div class="text-sm text-gray-600 mb-4">{{ department.description || 'No description available' }}</div>
                                    
                                    <div class="mt-3">
                                        <div class="text-sm font-medium mb-2">Associated Clinical Units:</div>
                                        <div class="flex flex-wrap gap-2">
                                            <span v-for="unit in getDepartmentUnits(department.id)" :key="unit.id" 
                                                  style="background: var(--medical-light-blue); color: var(--medical-blue); font-size: 12px; padding: 4px 12px; border-radius: 20px;">
                                                {{ unit.name }}
                                            </span>
                                            <span v-if="getDepartmentUnits(department.id).length === 0" class="text-gray-500 text-sm">
                                                No units assigned
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2" style="display: flex; gap: 8px;">
                                    <button class="btn btn-sm btn-primary flex-1" @click="editDepartment(department)"
                                            v-if="hasPermission('system', 'manage_departments')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <div class="action-dropdown">
                                        <button class="btn btn-sm btn-secondary" @click="toggleActionMenu($event)" aria-label="Department actions">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <div class="action-menu">
                                            <div class="action-menu-item" @click="viewDepartmentDetails(department)">
                                                <i class="fas fa-eye"></i>
                                                <span>View Details</span>
                                            </div>
                                            <div class="action-menu-item danger" @click="deleteDepartment(department.id)" v-if="hasPermission('system', 'manage_departments')">
                                                <i class="fas fa-trash"></i>
                                                <span>Delete</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Clinical Units Table -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-clinic-medical"></i>
                                    All Clinical Units
                                </div>
                            </div>
                            <div v-if="loading" class="loading-overlay">
                                <div class="loading-spinner"></div>
                            </div>
                            <div v-else-if="clinicalUnits.length === 0" class="empty-state">
                                <i class="fas fa-clinic-medical empty-state-icon"></i>
                                <div class="empty-state-title">No Clinical Units</div>
                                <div class="empty-state-description">
                                    No clinical units have been created yet.
                                </div>
                                <button class="btn btn-primary mt-4" @click="showAddClinicalUnitModal" v-if="hasPermission('system', 'manage_departments')">
                                    <i class="fas fa-plus"></i> Add Clinical Unit
                                </button>
                            </div>
                            <div v-else class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Unit Name</th>
                                            <th>Unit Code</th>
                                            <th>Department</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="unit in clinicalUnits" :key="unit.id">
                                            <td>{{ unit.name }}</td>
                                            <td>{{ unit.code }}</td>
                                            <td>{{ getDepartmentName(unit.department_id) }}</td>
                                            <td>
                                                <span class="badge" :class="unit.unit_type === 'clinical' ? 'badge-primary' : 'badge-info'">
                                                    {{ unit.unit_type }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge" :class="unit.status === 'active' ? 'status-available' : 'status-busy'">
                                                    {{ unit.status }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="action-dropdown">
                                                    <button class="btn btn-sm btn-secondary" @click="toggleActionMenu($event)" aria-label="Unit actions">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <div class="action-menu">
                                                        <div class="action-menu-item" @click="editClinicalUnit(unit)" v-if="hasPermission('system', 'manage_departments')">
                                                            <i class="fas fa-edit"></i>
                                                            <span>Edit</span>
                                                        </div>
                                                        <div class="action-menu-item danger" @click="deleteClinicalUnit(unit.id)" v-if="hasPermission('system', 'manage_departments')">
                                                            <i class="fas fa-trash"></i>
                                                            <span>Delete</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Training Units View -->
                    <div v-if="currentView === 'training_units'">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <div>
                                <h2 class="section-title" style="font-size: 24px; font-weight: 600; color: var(--medical-dark-blue);">Training Units Management</h2>
                                <p class="text-muted" style="color: var(--medical-gray);">Manage clinical training units and resident assignments</p>
                            </div>
                            <div class="flex gap-2" style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" @click="showAddTrainingUnitModal" v-if="hasPermission('training_units', 'create')">
                                    <i class="fas fa-plus"></i> Add Training Unit
                                </button>
                                <button class="btn btn-success" @click="showBulkAssignModal" v-if="hasPermission('training_units', 'update')">
                                    <i class="fas fa-users"></i> Bulk Assign
                                </button>
                            </div>
                        </div>

                        <!-- Training Units Grid -->
                        <div class="training-units-grid">
                            <div v-for="unit in trainingUnits" :key="unit.id" class="training-unit-card">
                                <div class="training-unit-header">
                                    <div>
                                        <div class="training-unit-title">{{ unit.name }}</div>
                                        <div class="training-unit-capacity">{{ unit.current_residents }}/{{ unit.max_capacity }} residents</div>
                                    </div>
                                    <span class="badge" :class="unit.status === 'active' ? 'status-available' : 'status-busy'">
                                        {{ unit.status }}
                                    </span>
                                </div>
                                
                                <div class="text-sm text-gray-600 mb-4">{{ unit.description || 'No description available' }}</div>
                                
                                <div class="training-unit-residents">
                                    <div class="text-sm font-medium mb-2">Assigned Residents:</div>
                                    <div v-if="getUnitResidents(unit.id).length === 0" class="text-sm text-gray-500 italic">
                                        No residents assigned
                                    </div>
                                    <div v-else>
                                        <div v-for="resident in getUnitResidents(unit.id)" :key="resident.id" class="resident-item">
                                            <div>
                                                <div class="resident-name">{{ resident.full_name }}</div>
                                                <div class="resident-level">{{ formatTrainingLevel(resident.training_level) }}</div>
                                            </div>
                                            <button class="btn btn-sm btn-outline-danger" @click="removeResidentFromUnit(resident.id, unit.id)" v-if="hasPermission('training_units', 'update')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2 mt-4">
                                    <button class="btn btn-sm btn-primary flex-1" @click="editTrainingUnit(unit)" v-if="hasPermission('training_units', 'update')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-secondary" @click="assignResidentToUnit(unit)" v-if="hasPermission('training_units', 'update')">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resident Rotations View -->
                    <div v-if="currentView === 'resident_rotations'">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <div>
                                <h2 class="section-title" style="font-size: 24px; font-weight: 600; color: var(--medical-dark-blue);">Resident Rotations</h2>
                                <p class="text-muted" style="color: var(--medical-gray);">Manage resident rotations and assignments</p>
                            </div>
                            <button class="btn btn-primary" @click="showAddRotationModal" v-if="hasPermission('resident_rotations', 'create')">
                                <i class="fas fa-plus"></i> Add Rotation
                            </button>
                        </div>

                        <!-- Filters -->
                        <div class="filter-bar" style="display: flex; gap: 12px; align-items: center; padding: 16px; background: white; border-radius: var(--border-radius-md); margin-bottom: 20px; flex-wrap: wrap; border: 1px solid var(--medical-light-blue);">
                            <div class="filter-group" style="display: flex; flex-direction: column; gap: 4px; min-width: 180px; flex: 1;">
                                <div class="filter-label" style="font-size: 12px; color: var(--medical-gray); font-weight: 500;">Resident</div>
                                <select class="form-select form-select-sm" v-model="rotationFilter.resident_id">
                                    <option value="">All Residents</option>
                                    <option v-for="resident in residents" :key="resident.id" :value="resident.id">
                                        {{ resident.full_name }}
                                    </option>
                                </select>
                            </div>
                            <div class="filter-group" style="display: flex; flex-direction: column; gap: 4px; min-width: 180px; flex: 1;">
                                <div class="filter-label" style="font-size: 12px; color: var(--medical-gray); font-weight: 500;">Status</div>
                                <select class="form-select form-select-sm" v-model="rotationFilter.status">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="upcoming">Upcoming</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="filter-actions" style="display: flex; gap: 8px; margin-left: auto;">
                                <button class="btn btn-sm btn-secondary" @click="resetRotationFilters">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                                <button class="btn btn-sm btn-primary" @click="applyRotationFilters">
                                    <i class="fas fa-filter"></i> Apply
                                </button>
                            </div>
                        </div>

                        <!-- Rotations Table -->
                        <div class="card">
                            <div v-if="loadingRotations" class="loading-overlay">
                                <div class="loading-spinner"></div>
                            </div>
                            <div v-else-if="filteredRotations.length === 0" class="empty-state">
                                <i class="fas fa-calendar-alt empty-state-icon"></i>
                                <div class="empty-state-title">No Rotations Found</div>
                                <div class="empty-state-description">
                                    Try adjusting your filters or add new rotations to get started.
                                </div>
                                <button class="btn btn-primary mt-4" @click="showAddRotationModal" v-if="hasPermission('resident_rotations', 'create')">
                                    <i class="fas fa-plus"></i> Add Rotation
                                </button>
                            </div>
                            <div v-else class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Resident</th>
                                            <th>Training Unit</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Status</th>
                                            <th>Supervisor</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="rotation in filteredRotations" :key="rotation.id">
                                            <td>{{ getResidentName(rotation.resident_id) }}</td>
                                            <td>{{ getTrainingUnitName(rotation.training_unit_id) }}</td>
                                            <td>{{ formatDate(rotation.start_date) }}</td>
                                            <td>{{ formatDate(rotation.end_date) }}</td>
                                            <td>
                                                <span class="badge" :class="getRotationStatusClass(rotation.status)">
                                                    {{ formatRotationStatus(rotation.status) }}
                                                </span>
                                            </td>
                                            <td>{{ getSupervisorName(rotation.supervisor_id) || 'Not assigned' }}</td>
                                            <td>
                                                <div class="action-dropdown">
                                                    <button class="btn btn-sm btn-secondary" @click="toggleActionMenu($event)" aria-label="Rotation actions">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <div class="action-menu">
                                                        <div class="action-menu-item" @click="viewRotationDetails(rotation)">
                                                            <i class="fas fa-eye"></i>
                                                            <span>View Details</span>
                                                        </div>
                                                        <div class="action-menu-item" @click="editRotation(rotation)" v-if="hasPermission('resident_rotations', 'update')">
                                                            <i class="fas fa-edit"></i>
                                                            <span>Edit</span>
                                                        </div>
                                                        <div class="action-menu-item danger" @click="deleteRotation(rotation.id)" v-if="hasPermission('resident_rotations', 'delete')">
                                                            <i class="fas fa-trash"></i>
                                                            <span>Delete</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Staff Absence View -->
                    <div v-if="currentView === 'staff_absence'">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <div>
                                <h2 class="section-title" style="font-size: 24px; font-weight: 600; color: var(--medical-dark-blue);">Staff Absence Management</h2>
                                <p class="text-muted" style="color: var(--medical-gray);">Track and manage staff absences and coverage</p>
                            </div>
                            <button class="btn btn-primary" @click="showAddAbsenceModal" v-if="hasPermission('staff_absence', 'create')">
                                <i class="fas fa-plus"></i> Document Absence
                            </button>
                        </div>

                        <!-- Filters -->
                        <div class="filter-bar" style="display: flex; gap: 12px; align-items: center; padding: 16px; background: white; border-radius: var(--border-radius-md); margin-bottom: 20px; flex-wrap: wrap; border: 1px solid var(--medical-light-blue);">
                            <div class="filter-group" style="display: flex; flex-direction: column; gap: 4px; min-width: 180px; flex: 1;">
                                <div class="filter-label" style="font-size: 12px; color: var(--medical-gray); font-weight: 500;">Staff Member</div>
                                <select class="form-select form-select-sm" v-model="absenceFilter.staff_id">
                                    <option value="">All Staff</option>
                                    <option v-for="staff in medicalStaff" :key="staff.id" :value="staff.id">
                                        {{ staff.full_name }}
                                    </option>
                                </select>
                            </div>
                            <div class="filter-group" style="display: flex; flex-direction: column; gap: 4px; min-width: 180px; flex: 1;">
                                <div class="filter-label" style="font-size: 12px; color: var(--medical-gray); font-weight: 500;">Status</div>
                                <select class="form-select form-select-sm" v-model="absenceFilter.status">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="upcoming">Upcoming</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="filter-group" style="display: flex; flex-direction: column; gap: 4px; min-width: 180px; flex: 1;">
                                <div class="filter-label" style="font-size: 12px; color: var(--medical-gray); font-weight: 500;">Date Range</div>
                                <input type="date" class="form-control form-control-sm" v-model="absenceFilter.start_date">
                            </div>
                            <div class="filter-actions" style="display: flex; gap: 8px; margin-left: auto;">
                                <button class="btn btn-sm btn-secondary" @click="resetAbsenceFilters">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                                <button class="btn btn-sm btn-primary" @click="applyAbsenceFilters">
                                    <i class="fas fa-filter"></i> Apply
                                </button>
                            </div>
                        </div>

                        <!-- Absence Calendar View -->
                        <div class="card mb-6">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-calendar"></i>
                                    Absence Calendar
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-secondary" @click="showAbsenceCalendar('month')">Month</button>
                                    <button class="btn btn-sm btn-secondary" @click="showAbsenceCalendar('week')">Week</button>
                                    <button class="btn btn-sm btn-secondary" @click="showAbsenceCalendar('list')">List</button>
                                </div>
                            </div>
                            <div class="p-4">
                                <div v-if="loadingAbsences" class="loading-overlay">
                                    <div class="loading-spinner"></div>
                                </div>
                                <div v-else-if="filteredAbsences.length === 0" class="empty-state">
                                    <i class="fas fa-calendar-times empty-state-icon"></i>
                                    <div class="empty-state-title">No Absences Found</div>
                                    <div class="empty-state-description">
                                        No staff absences have been documented yet.
                                    </div>
                                </div>
                                <div v-else class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Staff Member</th>
                                                <th>Absence Reason</th>
                                                <th>Start Date</th>
                                                <th>End Date</th>
                                                <th>Duration</th>
                                                <th>Coverage</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="absence in filteredAbsences" :key="absence.id">
                                                <td>{{ getStaffName(absence.staff_member_id) }}</td>
                                                <td>{{ formatAbsenceReason(absence.absence_reason) }}</td>
                                                <td>{{ formatDate(absence.start_date) }}</td>
                                                <td>{{ formatDate(absence.end_date) }}</td>
                                                <td>{{ calculateAbsenceDuration(absence.start_date, absence.end_date) }} days</td>
                                                <td>{{ getStaffName(absence.replacement_staff_id) || 'No coverage' }}</td>
                                                <td>
                                                    <span class="badge" :class="getAbsenceStatusClass(absence.status)">
                                                        {{ formatAbsenceStatus(absence.status) }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="action-dropdown">
                                                        <button class="btn btn-sm btn-secondary" @click="toggleActionMenu($event)" aria-label="Absence actions">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        <div class="action-menu">
                                                            <div class="action-menu-item" @click="viewAbsenceDetails(absence)">
                                                                <i class="fas fa-eye"></i>
                                                                <span>View Details</span>
                                                            </div>
                                                            <div class="action-menu-item" @click="editAbsence(absence)" v-if="hasPermission('staff_absence', 'update')">
                                                                <i class="fas fa-edit"></i>
                                                                <span>Edit</span>
                                                            </div>
                                                            <div class="action-menu-item" @click="assignCoverage(absence)" v-if="hasPermission('staff_absence', 'update') && !absence.replacement_staff_id">
                                                                <i class="fas fa-user-md"></i>
                                                                <span>Assign Coverage</span>
                                                            </div>
                                                            <div class="action-menu-item danger" @click="deleteAbsence(absence.id)" v-if="hasPermission('staff_absence', 'delete')">
                                                                <i class="fas fa-trash"></i>
                                                                <span>Delete</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Communications View -->
                    <div v-if="currentView === 'communications'">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <div>
                                <h2 class="section-title" style="font-size: 24px; font-weight: 600; color: var(--medical-dark-blue);">Department Communications</h2>
                                <p class="text-muted" style="color: var(--medical-gray);">Announcements, capacity planning, and quick updates</p>
                            </div>
                            <button class="btn btn-primary" @click="showCommunicationsModal" 
                                    v-if="hasPermission('communications', 'create')">
                                <i class="fas fa-plus"></i> New Communication
                            </button>
                        </div>

                        <!-- Communications Feed -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" style="display: grid; grid-template-columns: 1fr; gap: 24px;">
                            <div class="lg:col-span-2">
                                <div class="card mb-6">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-bullhorn"></i>
                                            Recent Announcements
                                        </div>
                                    </div>
                                    <div class="activity-feed" style="background: white; border-radius: var(--border-radius-lg); padding: 24px;">
                                        <div v-for="announcement in recentAnnouncements" :key="announcement.id" style="display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid var(--medical-light-blue);">
                                            <div :class="`bg-${getPriorityColor(announcement.priority_level)}`" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; flex-shrink: 0;">
                                                <i class="fas fa-bullhorn"></i>
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; margin-bottom: 4px;">{{ announcement.announcement_title }}</div>
                                                <div style="font-size: 14px; color: var(--gray-800); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{ announcement.announcement_content }}</div>
                                                <div style="font-size: 12px; color: var(--gray-500);">
                                                    {{ formatDateTime(announcement.publish_start_date) }} • 
                                                    <span class="badge badge-sm" :class="`badge-${getPriorityColor(announcement.priority_level)}`">
                                                        {{ announcement.priority_level }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="card mb-6">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <i class="fas fa-bed"></i>
                                            Today's Capacity
                                        </div>
                                        <span class="updated-timestamp" style="font-size: 11px; color: var(--medical-gray); display: flex; align-items: center; gap: 4px;">
                                            <i class="fas fa-sync"></i> Just now
                                        </span>
                                    </div>
                                    <div class="p-4">
                                        <div class="capacity-grid">
                                            <div class="capacity-card">
                                                <div class="capacity-card-header">
                                                    <div class="capacity-unit">Emergency Room</div>
                                                    <div class="capacity-status" :class="currentCapacity.er.status">
                                                        {{ currentCapacity.er.status }}
                                                    </div>
                                                </div>
                                                <div class="capacity-input-group">
                                                    <input type="number" class="capacity-input" v-model="currentCapacity.er.current" min="0" :max="currentCapacity.er.max" aria-label="ER current patients">
                                                    <span class="capacity-slash">/</span>
                                                    <input type="number" class="capacity-input" v-model="currentCapacity.er.max" min="1" aria-label="ER max capacity">
                                                </div>
                                            </div>
                                            
                                            <div class="capacity-card">
                                                <div class="capacity-card-header">
                                                    <div class="capacity-unit">Pulmo ICU</div>
                                                    <div class="capacity-status" :class="currentCapacity.icu.status">
                                                        {{ currentCapacity.icu.status }}
                                                    </div>
                                                </div>
                                                <div class="capacity-input-group">
                                                    <input type="number" class="capacity-input" v-model="currentCapacity.icu.current" min="0" :max="currentCapacity.icu.max" aria-label="ICU current patients">
                                                    <span class="capacity-slash">/</span>
                                                    <input type="number" class="capacity-input" v-model="currentCapacity.icu.max" min="1" aria-label="ICU max capacity">
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary w-full mt-4" @click="updateCapacity" v-if="hasPermission('communications', 'update')">
                                            <i class="fas fa-save"></i> Update Capacity
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Logs View -->
                    <div v-if="currentView === 'audit_logs'">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <div>
                                <h2 class="section-title" style="font-size: 24px; font-weight: 600; color: var(--medical-dark-blue);">Audit Logs</h2>
                                <p class="text-muted" style="color: var(--medical-gray);">System activity and user action tracking</p>
                            </div>
                            <button class="btn btn-primary" @click="exportAuditLogs" v-if="hasPermission('audit', 'export')">
                                <i class="fas fa-download"></i> Export Logs
                            </button>
                        </div>

                        <!-- Audit Filters -->
                        <div class="audit-filters">
                            <div class="filter-group" style="display: flex; flex-direction: column; gap: 4px; flex: 1;">
                                <div class="filter-label" style="font-size: 12px; color: var(--medical-gray); font-weight: 500;">Date Range</div>
                                <input type="date" class="form-control form-control-sm" v-model="auditFilters.dateRange">
                            </div>
                            <div class="filter-group" style="display: flex; flex-direction: column; gap: 4px; flex: 1;">
                                <div class="filter-label" style="font-size: 12px; color: var(--medical-gray); font-weight: 500;">Action Type</div>
                                <select class="form-select form-select-sm" v-model="auditFilters.actionType">
                                    <option value="">All Actions</option>
                                    <option value="create">Create</option>
                                    <option value="update">Update</option>
                                    <option value="delete">Delete</option>
                                    <option value="login">Login</option>
                                    <option value="logout">Logout</option>
                                </select>
                            </div>
                            <div class="filter-group" style="display: flex; flex-direction: column; gap: 4px; flex: 1;">
                                <div class="filter-label" style="font-size: 12px; color: var(--medical-gray); font-weight: 500;">User</div>
                                <select class="form-select form-select-sm" v-model="auditFilters.userId">
                                    <option value="">All Users</option>
                                    <option v-for="user in users" :key="user.id" :value="user.id">
                                        {{ user.full_name }}
                                    </option>
                                </select>
                            </div>
                            <div class="filter-actions" style="display: flex; gap: 8px; align-items: flex-end;">
                                <button class="btn btn-sm btn-secondary" @click="resetAuditFilters">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                                <button class="btn btn-sm btn-primary" @click="applyAuditFilters">
                                    <i class="fas fa-filter"></i> Apply
                                </button>
                            </div>
                        </div>

                        <!-- Audit Logs List -->
                        <div class="card">
                            <div v-if="loadingAuditLogs" class="loading-overlay">
                                <div class="loading-spinner"></div>
                            </div>
                            <div v-else-if="filteredAuditLogs.length === 0" class="empty-state">
                                <i class="fas fa-history empty-state-icon"></i>
                                <div class="empty-state-title">No Audit Logs Found</div>
                                <div class="empty-state-description">
                                    No audit logs match your filter criteria.
                                </div>
                            </div>
                            <div v-else>
                                <div v-for="log in filteredAuditLogs" :key="log.id" class="audit-log-item">
                                    <div class="audit-action">{{ formatAuditAction(log.action) }}</div>
                                    <div class="audit-details">
                                        <span>User: {{ getUserName(log.user_id) }}</span>
                                        <span>Module: {{ log.module }}</span>
                                        <span>IP: {{ log.ip_address }}</span>
                                    </div>
                                    <div class="audit-timestamp">
                                        <i class="fas fa-clock"></i> {{ formatDateTime(log.created_at) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Permission Manager View -->
                    <div v-if="currentView === 'permission_manager'">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <div>
                                <h2 class="section-title" style="font-size: 24px; font-weight: 600; color: var(--medical-dark-blue);">Permission Manager</h2>
                                <p class="text-muted" style="color: var(--medical-gray);">Manage user permissions and access controls</p>
                            </div>
                            <button class="btn btn-primary" @click="showAddRoleModal" v-if="hasPermission('permissions', 'manage')">
                                <i class="fas fa-plus"></i> Add Role
                            </button>
                        </div>

                        <!-- Permission Grid -->
                        <div class="permission-grid">
                            <div v-for="role in userRoles" :key="role.id" class="permission-card">
                                <div class="permission-header">
                                    <div class="permission-role">{{ role.name }}</div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-sm btn-primary" @click="editRole(role)" v-if="hasPermission('permissions', 'manage')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" @click="deleteRole(role.id)" v-if="hasPermission('permissions', 'manage') && role.name !== 'Administrator'">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="permission-checkboxes">
                                    <div v-for="permission in availablePermissions" :key="permission.id" class="form-check">
                                        <input type="checkbox" class="form-check-input" 
                                               :checked="roleHasPermission(role.id, permission.id)"
                                               @change="toggleRolePermission(role.id, permission.id)"
                                               :id="`role-${role.id}-permission-${permission.id}`">
                                        <label class="form-check-label" :for="`role-${role.id}-permission-${permission.id}`">
                                            {{ formatPermissionName(permission.name) }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Permissions Table -->
                        <div class="card mt-6">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-users"></i>
                                    User Permissions
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Role</th>
                                            <th>Permissions</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="user in users" :key="user.id">
                                            <td>{{ user.full_name }}</td>
                                            <td>{{ user.user_role }}</td>
                                            <td>
                                                <span class="badge badge-sm" v-for="permission in getUserPermissions(user.id)" :key="permission">
                                                    {{ permission }}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-primary" @click="editUserPermissions(user)" v-if="hasPermission('permissions', 'manage')">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- System Settings View -->
                    <div v-if="currentView === 'system_settings'">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <div>
                                <h2 class="section-title" style="font-size: 24px; font-weight: 600; color: var(--medical-dark-blue);">System Settings</h2>
                                <p class="text-muted" style="color: var(--medical-gray);">Configure system preferences and behavior</p>
                            </div>
                            <button class="btn btn-primary" @click="saveSystemSettings">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="modal-section">
                                    <div class="modal-section-title">
                                        <i class="fas fa-hospital"></i>
                                        Hospital Information
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">Hospital Name</label>
                                            <input type="text" class="form-control" v-model="systemSettings.hospital_name">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Default Department</label>
                                            <select class="form-select" v-model="systemSettings.default_department_id">
                                                <option value="">Select Default Department</option>
                                                <option v-for="department in departments" :key="department.id" :value="department.id">
                                                    {{ department.name }}
                                                </option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Max Residents per Training Unit</label>
                                            <input type="number" class="form-control" v-model="systemSettings.max_residents_per_unit" min="1" max="50">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Default Rotation Duration (weeks)</label>
                                            <input type="number" class="form-control" v-model="systemSettings.default_rotation_duration" min="1" max="52">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="modal-section">
                                    <div class="modal-section-title">
                                        <i class="fas fa-shield-alt"></i>
                                        Security Settings
                                    </div>
                                    <div class="form-group">
                                        <label class="form-check">
                                            <input type="checkbox" class="form-check-input" v-model="systemSettings.enable_audit_logging">
                                            <span class="form-check-label">Enable Audit Logging</span>
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-check">
                                            <input type="checkbox" class="form-check-input" v-model="systemSettings.require_mfa">
                                            <span class="form-check-label">Require MFA Authentication</span>
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-check">
                                            <input type="checkbox" class="form-check-input" v-model="systemSettings.maintenance_mode">
                                            <span class="form-check-label">Maintenance Mode</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="modal-section">
                                    <div class="modal-section-title">
                                        <i class="fas fa-bell"></i>
                                        Notification Settings
                                    </div>
                                    <div class="form-group">
                                        <label class="form-check">
                                            <input type="checkbox" class="form-check-input" v-model="systemSettings.notifications_enabled">
                                            <span class="form-check-label">Enable Email Notifications</span>
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-check">
                                            <input type="checkbox" class="form-check-input" v-model="systemSettings.absence_notifications">
                                            <span class="form-check-label">Staff Absence Notifications</span>
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-check">
                                            <input type="checkbox" class="form-check-input" v-model="systemSettings.announcement_notifications">
                                            <span class="form-check-label">Announcement Notifications</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- ============ MODALS ============ -->
        
        <!-- Staff Details Modal -->
        <div v-if="staffDetailsModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="staff-details-title">
            <div class="modal-container modal-xwide">
                <div class="modal-header">
                    <div class="modal-title" id="staff-details-title">
                        <i class="fas fa-user-md"></i>
                        Staff Profile
                    </div>
                    <button class="modal-close" @click="staffDetailsModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="staff-profile-header">
                        <div class="staff-avatar-large" aria-hidden="true">{{ getInitials(staffDetailsModal.staff.full_name) }}</div>
                        <div class="staff-basic-info">
                            <div class="staff-name">{{ staffDetailsModal.staff.full_name }}</div>
                            <div class="staff-title">{{ formatStaffType(staffDetailsModal.staff.staff_type) }}</div>
                            <span class="staff-status" :class="staffDetailsModal.staff.employment_status">
                                {{ formatEmploymentStatus(staffDetailsModal.staff.employment_status) }}
                            </span>
                        </div>
                    </div>

                    <div class="staff-stats">
                        <div class="staff-stat-card">
                            <div class="staff-stat-value">{{ staffDetailsModal.stats.completedRotations || 0 }}</div>
                            <div class="staff-stat-label">Completed Rotations</div>
                        </div>
                        <div class="staff-stat-card">
                            <div class="staff-stat-value">{{ staffDetailsModal.stats.oncallShifts || 0 }}</div>
                            <div class="staff-stat-label">On-call Shifts</div>
                        </div>
                        <div class="staff-stat-card">
                            <div class="staff-stat-value">{{ staffDetailsModal.stats.absenceDays || 0 }}</div>
                            <div class="staff-stat-label">Absence Days</div>
                        </div>
                        <div class="staff-stat-card">
                            <div class="staff-stat-value">{{ staffDetailsModal.stats.supervisionCount || 0 }}</div>
                            <div class="staff-stat-label">Residents Supervised</div>
                        </div>
                    </div>

                    <div class="modal-tabs" role="tablist">
                        <button class="modal-tab" :class="{ active: staffDetailsModal.activeTab === 'personal' }" 
                                @click="staffDetailsModal.activeTab = 'personal'" role="tab" aria-selected="staffDetailsModal.activeTab === 'personal'">
                            <i class="fas fa-user"></i> Personal Info
                        </button>
                        <button class="modal-tab" :class="{ active: staffDetailsModal.activeTab === 'professional' }" 
                                @click="staffDetailsModal.activeTab = 'professional'" role="tab" aria-selected="staffDetailsModal.activeTab === 'professional'">
                            <i class="fas fa-briefcase"></i> Professional Info
                        </button>
                        <button class="modal-tab" :class="{ active: staffDetailsModal.activeTab === 'contact' }" 
                                @click="staffDetailsModal.activeTab = 'contact'" role="tab" aria-selected="staffDetailsModal.activeTab === 'contact'">
                            <i class="fas fa-address-book"></i> Contact & Schedule
                        </button>
                        <button class="modal-tab" :class="{ active: staffDetailsModal.activeTab === 'history' }" 
                                @click="staffDetailsModal.activeTab = 'history'" role="tab" aria-selected="staffDetailsModal.activeTab === 'history'">
                            <i class="fas fa-history"></i> Activity History
                        </button>
                    </div>

                    <!-- Personal Info Tab -->
                    <div v-if="staffDetailsModal.activeTab === 'personal'" class="modal-tab-content active" role="tabpanel">
                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-id-card"></i>
                                Personal Information
                            </div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Date of Birth</div>
                                    <div class="info-value" :class="staffDetailsModal.staff.date_of_birth ? '' : 'unavailable'">
                                        {{ staffDetailsModal.staff.date_of_birth || 'Information unavailable' }}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Medical License</div>
                                    <div class="info-value" :class="staffDetailsModal.staff.medical_license ? '' : 'unavailable'">
                                        {{ staffDetailsModal.staff.medical_license || 'Information unavailable' }}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Years of Experience</div>
                                    <div class="info-value" :class="staffDetailsModal.staff.years_experience ? '' : 'unavailable'">
                                        {{ staffDetailsModal.staff.years_experience || 'Information unavailable' }}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Biography</div>
                                    <div class="info-value" :class="staffDetailsModal.staff.biography ? '' : 'unavailable'">
                                        {{ staffDetailsModal.staff.biography || 'No biography available' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Info Tab -->
                    <div v-if="staffDetailsModal.activeTab === 'professional'" class="modal-tab-content active" role="tabpanel">
                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-graduation-cap"></i>
                                Professional Information
                            </div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Staff ID</div>
                                    <div class="info-value">{{ staffDetailsModal.staff.staff_id }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Professional Email</div>
                                    <div class="info-value">{{ staffDetailsModal.staff.professional_email }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Department</div>
                                    <div class="info-value" :class="staffDetailsModal.staff.department_id ? '' : 'unavailable'">
                                        {{ getDepartmentName(staffDetailsModal.staff.department_id) || 'Department information unavailable' }}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Specialization</div>
                                    <div class="info-value" :class="staffDetailsModal.staff.specialization ? '' : 'unavailable'">
                                        {{ staffDetailsModal.staff.specialization || 'Specialization information unavailable' }}
                                    </div>
                                </div>
                                <div v-if="staffDetailsModal.staff.staff_type === 'medical_resident'" class="info-item">
                                    <div class="info-label">Resident Category</div>
                                    <div class="info-value" :class="staffDetailsModal.staff.resident_category ? '' : 'unavailable'">
                                        {{ staffDetailsModal.staff.resident_category ? formatResidentCategory(staffDetailsModal.staff.resident_category) : 'Resident category unavailable' }}
                                    </div>
                                </div>
                                <div v-if="staffDetailsModal.staff.staff_type === 'medical_resident'" class="info-item">
                                    <div class="info-label">Training Level</div>
                                    <div class="info-value" :class="staffDetailsModal.staff.training_level ? '' : 'unavailable'">
                                        {{ staffDetailsModal.staff.training_level ? formatTrainingLevel(staffDetailsModal.staff.training_level) : 'Training level unavailable' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact & Schedule Tab -->
                    <div v-if="staffDetailsModal.activeTab === 'contact'" class="modal-tab-content active" role="tabpanel">
                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-calendar-alt"></i>
                                Schedule Information
                            </div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Current Rotation</div>
                                    <div class="info-value" :class="staffDetailsModal.currentRotation ? '' : 'unavailable'">
                                        {{ staffDetailsModal.currentRotation || 'No active rotation' }}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Next On-call</div>
                                    <div class="info-value" :class="staffDetailsModal.nextOncall ? '' : 'unavailable'">
                                        {{ staffDetailsModal.nextOncall || 'No upcoming on-call scheduled' }}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Office Phone</div>
                                    <div class="info-value" :class="staffDetailsModal.staff.office_phone ? '' : 'unavailable'">
                                        {{ staffDetailsModal.staff.office_phone || 'Office phone unavailable' }}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Mobile Phone</div>
                                    <div class="info-value" :class="staffDetailsModal.staff.mobile_phone ? '' : 'unavailable'">
                                        {{ staffDetailsModal.staff.mobile_phone || 'Mobile phone unavailable' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity History Tab -->
                    <div v-if="staffDetailsModal.activeTab === 'history'" class="modal-tab-content active" role="tabpanel">
                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-history"></i>
                                Activity History
                            </div>
                            <div v-if="staffDetailsModal.activityHistory.length === 0" class="empty-state">
                                <i class="fas fa-history empty-state-icon"></i>
                                <div class="empty-state-title">No Activity History</div>
                                <div class="empty-state-description">
                                    No activity history found for this staff member.
                                </div>
                            </div>
                            <div v-else>
                                <div v-for="activity in staffDetailsModal.activityHistory" :key="activity.id" class="audit-log-item">
                                    <div class="audit-action">{{ formatAuditAction(activity.action) }}</div>
                                    <div class="audit-details">
                                        <span>Module: {{ activity.module }}</span>
                                        <span>Details: {{ activity.details }}</span>
                                    </div>
                                    <div class="audit-timestamp">
                                        <i class="fas fa-clock"></i> {{ formatDateTime(activity.created_at) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="staffDetailsModal.show = false">Close</button>
                    <button class="btn btn-primary" @click="editMedicalStaff(staffDetailsModal.staff)"
                            v-if="hasPermission('medical_staff', 'update')">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Medical Staff Modal -->
        <div v-if="medicalStaffModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="medical-staff-title">
            <div class="modal-container modal-wide">
                <div class="modal-header">
                    <div class="modal-title" id="medical-staff-title">
                        <i class="fas fa-user-md"></i>
                        {{ medicalStaffModal.mode === 'add' ? 'Add Medical Staff' : 'Edit Medical Staff' }}
                    </div>
                    <button class="modal-close" @click="medicalStaffModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-tabs" role="tablist">
                        <button class="modal-tab" :class="{ active: medicalStaffModal.activeTab === 'basic' }" 
                                @click="medicalStaffModal.activeTab = 'basic'" role="tab" aria-selected="medicalStaffModal.activeTab === 'basic'">
                            <i class="fas fa-user"></i> Basic Information
                        </button>
                        <button class="modal-tab" :class="{ active: medicalStaffModal.activeTab === 'professional' }" 
                                @click="medicalStaffModal.activeTab = 'professional'" role="tab" aria-selected="medicalStaffModal.activeTab === 'professional'">
                            <i class="fas fa-graduation-cap"></i> Professional Details
                        </button>
                        <button class="modal-tab" :class="{ active: medicalStaffModal.activeTab === 'contact' }" 
                                @click="medicalStaffModal.activeTab = 'contact'" role="tab" aria-selected="medicalStaffModal.activeTab === 'contact'">
                            <i class="fas fa-address-book"></i> Contact Information
                        </button>
                    </div>

                    <!-- Basic Information Tab -->
                    <div v-if="medicalStaffModal.activeTab === 'basic'" class="modal-tab-content active" role="tabpanel">
                        <div class="modal-section">
                            <div class="modal-section-title">
                                <i class="fas fa-id-card"></i>
                                Basic Information
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" v-model="medicalStaffModal.form.full_name" aria-required="true">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Staff Type *</label>
                                    <select class="form-select" v-model="medicalStaffModal.form.staff_type" aria-required="true">
                                        <option value="medical_resident">Medical Resident</option>
                                        <option value="attending_physician">Attending Physician</option>
                                        <option value="fellow">Fellow</option>
                                        <option value="nurse_practitioner">Nurse Practitioner</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Staff ID</label>
                                    <input type="text" class="form-control" v-model="medicalStaffModal.form.staff_id">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Employment Status</label>
                                    <select class="form-select" v-model="medicalStaffModal.form.employment_status">
                                        <option value="active">Active</option>
                                        <option value="on_leave">On Leave</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Details Tab -->
                    <div v-if="medicalStaffModal.activeTab === 'professional'" class="modal-tab-content active" role="tabpanel">
                        <div class="modal-section">
                            <div class="modal-section-title">
                                <i class="fas fa-graduation-cap"></i>
                                Professional Details
                            </div>
                            
                            <div v-if="medicalStaffModal.form.staff_type === 'medical_resident'">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label class="form-label">Resident Category</label>
                                        <select class="form-select" v-model="medicalStaffModal.form.resident_category">
                                            <option value="">Select Category</option>
                                            <option value="department_internal">Department Internal</option>
                                            <option value="rotating_other_dept">Rotating Other Dept</option>
                                            <option value="external_institution">External Institution</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Training Level</label>
                                        <select class="form-select" v-model="medicalStaffModal.form.training_level">
                                            <option value="">Select Level</option>
                                            <option value="pgy1">PGY-1</option>
                                            <option value="pgy2">PGY-2</option>
                                            <option value="pgy3">PGY-3</option>
                                            <option value="pgy4">PGY-4</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div v-if="medicalStaffModal.form.staff_type === 'attending_physician'">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label class="form-label">Specialization</label>
                                        <input type="text" class="form-control" v-model="medicalStaffModal.form.specialization">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Years of Experience</label>
                                        <input type="number" class="form-control" v-model="medicalStaffModal.form.years_experience" min="0" max="50">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Biography</label>
                                <textarea class="form-control" v-model="medicalStaffModal.form.biography" rows="4"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Tab -->
                    <div v-if="medicalStaffModal.activeTab === 'contact'" class="modal-tab-content active" role="tabpanel">
                        <div class="modal-section">
                            <div class="modal-section-title">
                                <i class="fas fa-envelope"></i>
                                Contact Information
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Professional Email *</label>
                                    <input type="email" class="form-control" v-model="medicalStaffModal.form.professional_email" aria-required="true">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Department</label>
                                    <select class="form-select" v-model="medicalStaffModal.form.department_id">
                                        <option value="">Select Department</option>
                                        <option v-for="department in departments" :key="department.id" :value="department.id">
                                            {{ department.name }}
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Office Phone</label>
                                    <input type="tel" class="form-control" v-model="medicalStaffModal.form.office_phone">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mobile Phone</label>
                                    <input type="tel" class="form-control" v-model="medicalStaffModal.form.mobile_phone">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Medical License Number</label>
                                    <input type="text" class="form-control" v-model="medicalStaffModal.form.medical_license">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" v-model="medicalStaffModal.form.date_of_birth">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="medicalStaffModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveMedicalStaff" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else>{{ medicalStaffModal.mode === 'add' ? 'Add Staff' : 'Save Changes' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Department Modal -->
        <div v-if="departmentModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="department-title">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title" id="department-title">
                        <i class="fas fa-hospital"></i>
                        {{ departmentModal.mode === 'add' ? 'Add Department' : 'Edit Department' }}
                    </div>
                    <button class="modal-close" @click="departmentModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-info-circle"></i>
                            Department Information
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Department Name *</label>
                                <input type="text" class="form-control" v-model="departmentModal.form.name" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Department Code *</label>
                                <input type="text" class="form-control" v-model="departmentModal.form.code" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" v-model="departmentModal.form.status">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="archived">Archived</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Head of Department</label>
                                <select class="form-select" v-model="departmentModal.form.head_of_department_id">
                                    <option value="">Select Head</option>
                                    <option v-for="staff in availableHeadsOfDepartment" :key="staff.id" :value="staff.id">
                                        {{ staff.full_name }}
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" v-model="departmentModal.form.description" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="departmentModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveDepartment" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else>{{ departmentModal.mode === 'add' ? 'Add Department' : 'Save Changes' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Clinical Unit Modal -->
        <div v-if="clinicalUnitModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="clinical-unit-title">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title" id="clinical-unit-title">
                        <i class="fas fa-clinic-medical"></i>
                        {{ clinicalUnitModal.mode === 'add' ? 'Add Clinical Unit' : 'Edit Clinical Unit' }}
                    </div>
                    <button class="modal-close" @click="clinicalUnitModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-info-circle"></i>
                            Clinical Unit Information
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Unit Name *</label>
                                <input type="text" class="form-control" v-model="clinicalUnitModal.form.name" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unit Code *</label>
                                <input type="text" class="form-control" v-model="clinicalUnitModal.form.code" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Department *</label>
                                <select class="form-select" v-model="clinicalUnitModal.form.department_id" aria-required="true">
                                    <option value="">Select Department</option>
                                    <option v-for="department in departments" :key="department.id" :value="department.id">
                                        {{ department.name }}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unit Type</label>
                                <select class="form-select" v-model="clinicalUnitModal.form.unit_type">
                                    <option value="clinical">Clinical</option>
                                    <option value="administrative">Administrative</option>
                                    <option value="support">Support</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" v-model="clinicalUnitModal.form.status">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="maintenance">Maintenance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Supervisor</label>
                                <select class="form-select" v-model="clinicalUnitModal.form.supervisor_id">
                                    <option value="">Select Supervisor</option>
                                    <option v-for="staff in availableSupervisors" :key="staff.id" :value="staff.id">
                                        {{ staff.full_name }}
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" v-model="clinicalUnitModal.form.description" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="clinicalUnitModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveClinicalUnit" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else>{{ clinicalUnitModal.mode === 'add' ? 'Add Clinical Unit' : 'Save Changes' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Training Unit Modal -->
        <div v-if="trainingUnitModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="training-unit-title">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title" id="training-unit-title">
                        <i class="fas fa-clinic-medical"></i>
                        {{ trainingUnitModal.mode === 'add' ? 'Add Training Unit' : 'Edit Training Unit' }}
                    </div>
                    <button class="modal-close" @click="trainingUnitModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-info-circle"></i>
                            Training Unit Information
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Unit Name *</label>
                                <input type="text" class="form-control" v-model="trainingUnitModal.form.name" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Department *</label>
                                <select class="form-select" v-model="trainingUnitModal.form.department_id" aria-required="true">
                                    <option value="">Select Department</option>
                                    <option v-for="department in departments" :key="department.id" :value="department.id">
                                        {{ department.name }}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Supervisor</label>
                                <select class="form-select" v-model="trainingUnitModal.form.supervisor_id">
                                    <option value="">Select Supervisor</option>
                                    <option v-for="staff in availableAttendings" :key="staff.id" :value="staff.id">
                                        {{ staff.full_name }}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Capacity</label>
                                <input type="number" class="form-control" v-model="trainingUnitModal.form.max_capacity" min="1" max="50">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" v-model="trainingUnitModal.form.status">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="maintenance">Maintenance</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" v-model="trainingUnitModal.form.description" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="trainingUnitModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveTrainingUnit" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else>{{ trainingUnitModal.mode === 'add' ? 'Add Training Unit' : 'Save Changes' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Rotation Modal -->
        <div v-if="rotationModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="rotation-title">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title" id="rotation-title">
                        <i class="fas fa-calendar-alt"></i>
                        {{ rotationModal.mode === 'add' ? 'Add Rotation' : 'Edit Rotation' }}
                    </div>
                    <button class="modal-close" @click="rotationModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-user-graduate"></i>
                            Rotation Details
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Resident *</label>
                                <select class="form-select" v-model="rotationModal.form.resident_id" aria-required="true">
                                    <option value="">Select Resident</option>
                                    <option v-for="resident in availableResidents" :key="resident.id" :value="resident.id">
                                        {{ resident.full_name }} ({{ formatTrainingLevel(resident.training_level) }})
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Training Unit *</label>
                                <select class="form-select" v-model="rotationModal.form.training_unit_id" aria-required="true">
                                    <option value="">Select Unit</option>
                                    <option v-for="unit in availableTrainingUnits" :key="unit.id" :value="unit.id">
                                        {{ unit.name }} ({{ unit.current_residents }}/{{ unit.max_capacity }})
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Start Date *</label>
                                <input type="date" class="form-control" v-model="rotationModal.form.start_date" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Date *</label>
                                <input type="date" class="form-control" v-model="rotationModal.form.end_date" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Supervisor</label>
                                <select class="form-select" v-model="rotationModal.form.supervisor_id">
                                    <option value="">Select Supervisor</option>
                                    <option v-for="supervisor in availableSupervisors" :key="supervisor.id" :value="supervisor.id">
                                        {{ supervisor.full_name }}
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" v-model="rotationModal.form.status">
                                    <option value="active">Active</option>
                                    <option value="upcoming">Upcoming</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Rotation Goals</label>
                            <textarea class="form-control" v-model="rotationModal.form.goals" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" v-model="rotationModal.form.notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="rotationModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveRotation" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else>{{ rotationModal.mode === 'add' ? 'Add Rotation' : 'Save Changes' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit On-call Schedule Modal -->
        <div v-if="onCallModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="oncall-title">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title" id="oncall-title">
                        <i class="fas fa-phone-alt"></i>
                        {{ onCallModal.mode === 'add' ? 'Add On-call Schedule' : 'Edit On-call Schedule' }}
                    </div>
                    <button class="modal-close" @click="onCallModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-calendar"></i>
                            Schedule Details
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Duty Date *</label>
                                <input type="date" class="form-control" v-model="onCallModal.form.duty_date" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Shift Type</label>
                                <select class="form-select" v-model="onCallModal.form.shift_type">
                                    <option value="backup_call">Backup Call</option>
                                    <option value="primary_call">Primary Call</option>
                                    <option value="emergency_call">Emergency Call</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-control" v-model="onCallModal.form.start_time">
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-control" v-model="onCallModal.form.end_time">
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-user-md"></i>
                            Physician Assignment
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Primary Physician *</label>
                                <select class="form-select" v-model="onCallModal.form.primary_physician_id" aria-required="true">
                                    <option value="">Select Physician</option>
                                    <option v-for="physician in availablePhysicians" :key="physician.id" :value="physician.id">
                                        {{ physician.full_name }} ({{ formatStaffType(physician.staff_type) }})
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Backup Physician</label>
                                <select class="form-select" v-model="onCallModal.form.backup_physician_id">
                                    <option value="">Select Backup Physician</option>
                                    <option v-for="physician in availablePhysicians" :key="physician.id" :value="physician.id">
                                        {{ physician.full_name }} ({{ formatStaffType(physician.staff_type) }})
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-sticky-note"></i>
                            Additional Information
                        </div>
                        <div class="form-group">
                            <label class="form-label">Coverage Notes</label>
                            <textarea class="form-control" v-model="onCallModal.form.coverage_notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="onCallModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveOnCallSchedule" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else>{{ onCallModal.mode === 'add' ? 'Add Schedule' : 'Save Changes' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Staff Absence Modal -->
        <div v-if="absenceModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="absence-title">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title" id="absence-title">
                        <i class="fas fa-calendar-times"></i>
                        {{ absenceModal.mode === 'add' ? 'Document Staff Absence' : 'Edit Absence Record' }}
                    </div>
                    <button class="modal-close" @click="absenceModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-calendar-alt"></i>
                            Absence Details
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Staff Member *</label>
                                <select class="form-select" v-model="absenceModal.form.staff_member_id" aria-required="true">
                                    <option value="">Select Staff Member</option>
                                    <option v-for="staff in availableStaff" :key="staff.id" :value="staff.id">
                                        {{ staff.full_name }} ({{ formatStaffType(staff.staff_type) }})
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Absence Reason *</label>
                                <select class="form-select" v-model="absenceModal.form.absence_reason" aria-required="true">
                                    <option value="">Select Reason</option>
                                    <option value="vacation">Vacation</option>
                                    <option value="sick_leave">Sick Leave</option>
                                    <option value="conference">Conference/Education</option>
                                    <option value="personal">Personal</option>
                                    <option value="maternity_paternity">Maternity/Paternity</option>
                                    <option value="administrative">Administrative Duty</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Start Date *</label>
                                <input type="date" class="form-control" v-model="absenceModal.form.start_date" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Date *</label>
                                <input type="date" class="form-control" v-model="absenceModal.form.end_date" aria-required="true">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Additional Notes</label>
                            <textarea class="form-control" v-model="absenceModal.form.notes" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-user-md"></i>
                            Coverage Arrangement
                        </div>
                        <div class="form-group">
                            <label class="form-label">Replacement Staff</label>
                            <select class="form-select" v-model="absenceModal.form.replacement_staff_id">
                                <option value="">No Replacement (Coverage Managed Elsewhere)</option>
                                <option v-for="staff in availableCoverageStaff" :key="staff.id" :value="staff.id">
                                    {{ staff.full_name }} ({{ formatStaffType(staff.staff_type) }})
                                </option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Coverage Instructions</label>
                            <textarea class="form-control" v-model="absenceModal.form.coverage_instructions" rows="3" 
                                      placeholder="Any specific instructions for covering clinical duties..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="absenceModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveAbsence" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else>{{ absenceModal.mode === 'add' ? 'Document Absence' : 'Save Changes' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Placement Modal -->
        <div v-if="quickPlacementModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="quick-placement-title">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title" id="quick-placement-title">
                        <i class="fas fa-user-md"></i>
                        Quick Resident Placement
                    </div>
                    <button class="modal-close" @click="quickPlacementModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-user-graduate"></i>
                            Select Resident
                        </div>
                        <div class="form-group">
                            <label class="form-label">Resident *</label>
                            <select class="form-select" v-model="quickPlacementModal.resident_id" aria-required="true">
                                <option value="">Select Resident</option>
                                <option v-for="resident in availableResidents" :key="resident.id" :value="resident.id">
                                    {{ resident.full_name }} ({{ resident.training_level }})
                                </option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-clinic-medical"></i>
                            Placement Details
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Training Unit *</label>
                                <select class="form-select" v-model="quickPlacementModal.training_unit_id" aria-required="true">
                                    <option value="">Select Unit</option>
                                    <option v-for="unit in availableTrainingUnits" :key="unit.id" :value="unit.id">
                                        {{ unit.name }} ({{ unit.current_residents }}/{{ unit.max_capacity }})
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Start Date *</label>
                                <input type="date" class="form-control" v-model="quickPlacementModal.start_date" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Duration (weeks)</label>
                                <input type="number" class="form-control" v-model="quickPlacementModal.duration" min="1" max="52" value="4">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Supervisor</label>
                                <select class="form-select" v-model="quickPlacementModal.supervisor_id">
                                    <option value="">Select Supervisor</option>
                                    <option v-for="supervisor in availableSupervisors" :key="supervisor.id" :value="supervisor.id">
                                        {{ supervisor.full_name }}
                                    </option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" v-model="quickPlacementModal.notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="quickPlacementModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveQuickPlacement" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else><i class="fas fa-check"></i> Place Resident</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Bulk Assign Modal -->
        <div v-if="bulkAssignModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="bulk-assign-title">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title" id="bulk-assign-title">
                        <i class="fas fa-users"></i>
                        Bulk Resident Assignment
                    </div>
                    <button class="modal-close" @click="bulkAssignModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-user-graduate"></i>
                            Select Residents
                        </div>
                        <div class="form-group">
                            <label class="form-label">Available Residents</label>
                            <select class="form-select" v-model="bulkAssignModal.selectedResidents" multiple style="height: 200px;">
                                <option v-for="resident in availableResidents" :key="resident.id" :value="resident.id">
                                    {{ resident.full_name }} ({{ resident.training_level }})
                                </option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-clinic-medical"></i>
                            Assignment Details
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Training Unit *</label>
                                <select class="form-select" v-model="bulkAssignModal.training_unit_id" aria-required="true">
                                    <option value="">Select Unit</option>
                                    <option v-for="unit in availableTrainingUnits" :key="unit.id" :value="unit.id">
                                        {{ unit.name }} ({{ unit.current_residents }}/{{ unit.max_capacity }})
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Start Date *</label>
                                <input type="date" class="form-control" v-model="bulkAssignModal.start_date" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Duration (weeks)</label>
                                <input type="number" class="form-control" v-model="bulkAssignModal.duration" min="1" max="52" value="4">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Supervisor</label>
                                <select class="form-select" v-model="bulkAssignModal.supervisor_id">
                                    <option value="">Select Supervisor</option>
                                    <option v-for="supervisor in availableSupervisors" :key="supervisor.id" :value="supervisor.id">
                                        {{ supervisor.full_name }}
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="bulkAssignModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveBulkAssignment" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else><i class="fas fa-users"></i> Assign Residents</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Communications Modal -->
        <div v-if="communicationsModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="communications-title">
            <div class="modal-container modal-wide">
                <div class="modal-header">
                    <div class="modal-title" id="communications-title">
                        <i class="fas fa-comments"></i>
                        Department Communications
                    </div>
                    <button class="modal-close" @click="communicationsModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-tabs" role="tablist">
                        <button class="modal-tab" :class="{ active: communicationsModal.activeTab === 'announcement' }" 
                                @click="communicationsModal.activeTab = 'announcement'" role="tab" aria-selected="communicationsModal.activeTab === 'announcement'">
                            <i class="fas fa-bullhorn"></i> Announcement
                        </button>
                        <button class="modal-tab" :class="{ active: communicationsModal.activeTab === 'capacity' }" 
                                @click="communicationsModal.activeTab = 'capacity'" role="tab" aria-selected="communicationsModal.activeTab === 'capacity'">
                            <i class="fas fa-bed"></i> Capacity Planning
                        </button>
                        <button class="modal-tab" :class="{ active: communicationsModal.activeTab === 'quick' }" 
                                @click="communicationsModal.activeTab = 'quick'" role="tab" aria-selected="communicationsModal.activeTab === 'quick'">
                            <i class="fas fa-comment-medical"></i> Quick Update
                        </button>
                    </div>

                    <!-- Announcement Tab -->
                    <div v-if="communicationsModal.activeTab === 'announcement'" class="modal-tab-content active" role="tabpanel">
                        <div class="modal-section">
                            <div class="modal-section-title">
                                <i class="fas fa-edit"></i>
                                Announcement Details
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title *</label>
                                <input type="text" class="form-control" v-model="communicationsModal.form.announcement_title" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Content *</label>
                                <textarea class="form-control" v-model="communicationsModal.form.announcement_content" rows="6" aria-required="true"></textarea>
                            </div>
                        </div>
                        
                        <div class="modal-section">
                            <div class="modal-section-title">
                                <i class="fas fa-cog"></i>
                                Settings
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Publish Date *</label>
                                    <input type="date" class="form-control" v-model="communicationsModal.form.publish_start_date" aria-required="true">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Expiry Date</label>
                                    <input type="date" class="form-control" v-model="communicationsModal.form.publish_end_date">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Priority Level</label>
                                    <select class="form-select" v-model="communicationsModal.form.priority_level">
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Target Audience</label>
                                    <select class="form-select" v-model="communicationsModal.form.target_audience">
                                        <option value="all">All Staff</option>
                                        <option value="residents">Residents Only</option>
                                        <option value="attendings">Attending Physicians</option>
                                        <option value="nursing">Nursing Staff</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Capacity Planning Tab -->
                    <div v-if="communicationsModal.activeTab === 'capacity'" class="modal-tab-content active" role="tabpanel">
                        <div class="modal-section">
                            <div class="modal-section-title">
                                <i class="fas fa-hospital"></i>
                                Daily Capacity Planning
                            </div>
                            <p class="text-sm text-gray-600 mb-4">Set expected patient numbers for today</p>
                            
                            <div class="capacity-grid">
                                <div class="capacity-card">
                                    <div class="capacity-card-header">
                                        <div class="capacity-unit">Emergency Room</div>
                                        <div class="capacity-status" :class="getCapacityStatus(communicationsModal.capacity.er)">
                                            {{ getCapacityStatus(communicationsModal.capacity.er) }}
                                        </div>
                                    </div>
                                    <div class="capacity-input-group">
                                        <input type="number" class="capacity-input" v-model="communicationsModal.capacity.er.current" 
                                               placeholder="Current" min="0" :max="communicationsModal.capacity.er.max" aria-label="ER current patients">
                                        <span class="capacity-slash">/</span>
                                        <input type="number" class="capacity-input" v-model="communicationsModal.capacity.er.max" 
                                               placeholder="Capacity" min="1" aria-label="ER max capacity">
                                    </div>
                                    <div class="mt-2">
                                        <input type="text" class="form-control form-control-sm" 
                                               v-model="communicationsModal.capacity.er.notes" placeholder="Notes (e.g., 'High flu season')">
                                    </div>
                                </div>
                                
                                <div class="capacity-card">
                                    <div class="capacity-card-header">
                                        <div class="capacity-unit">Pulmo ICU</div>
                                        <div class="capacity-status" :class="getCapacityStatus(communicationsModal.capacity.icu)">
                                            {{ getCapacityStatus(communicationsModal.capacity.icu) }}
                                        </div>
                                    </div>
                                    <div class="capacity-input-group">
                                        <input type="number" class="capacity-input" v-model="communicationsModal.capacity.icu.current" 
                                               placeholder="Current" min="0" :max="communicationsModal.capacity.icu.max" aria-label="ICU current patients">
                                        <span class="capacity-slash">/</span>
                                        <input type="number" class="capacity-input" v-model="communicationsModal.capacity.icu.max" 
                                               placeholder="Capacity" min="1" aria-label="ICU max capacity">
                                    </div>
                                    <div class="mt-2">
                                        <input type="text" class="form-control form-control-sm" 
                                               v-model="communicationsModal.capacity.icu.notes" placeholder="Notes">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group mt-4">
                                <label class="form-label">Overall Notes & Alerts</label>
                                <textarea class="form-control" v-model="communicationsModal.capacity.overall_notes" rows="3" 
                                          placeholder="Add any additional notes or alerts for the department..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Update Tab -->
                    <div v-if="communicationsModal.activeTab === 'quick'" class="modal-tab-content active" role="tabpanel">
                        <div class="modal-section">
                            <div class="modal-section-title">
                                <i class="fas fa-comment-medical"></i>
                                Quick Status Update
                            </div>
                            <div class="form-group">
                                <label class="form-label">Message *</label>
                                <textarea class="form-control" v-model="communicationsModal.quickUpdate.message" rows="4" 
                                          placeholder="What's the latest update? (e.g., 'CT scanner maintenance until 2 PM', 'New guideline for asthma management available')" aria-required="true"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" v-model="communicationsModal.quickUpdate.priority">
                                        <option value="info">Information</option>
                                        <option value="warning">Warning</option>
                                        <option value="alert">Alert</option>
                                        <option value="update">Update</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Expires In</label>
                                    <select class="form-select" v-model="communicationsModal.quickUpdate.expires">
                                        <option value="1">1 hour</option>
                                        <option value="4">4 hours</option>
                                        <option value="8">8 hours</option>
                                        <option value="24">24 hours</option>
                                        <option value="168">1 week</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tags (comma separated)</label>
                                <input type="text" class="form-control" v-model="communicationsModal.quickUpdate.tags" 
                                       placeholder="equipment, guidelines, staffing, maintenance">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="communicationsModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveCommunication" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else>
                            <i class="fas" :class="getCommunicationIcon(communicationsModal.activeTab)"></i>
                            {{ getCommunicationButtonText(communicationsModal.activeTab) }}
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Permission Role Modal -->
        <div v-if="roleModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="role-title">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title" id="role-title">
                        <i class="fas fa-user-shield"></i>
                        {{ roleModal.mode === 'add' ? 'Add Role' : 'Edit Role' }}
                    </div>
                    <button class="modal-close" @click="roleModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-info-circle"></i>
                            Role Information
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role Name *</label>
                            <input type="text" class="form-control" v-model="roleModal.form.name" aria-required="true">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" v-model="roleModal.form.description" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-shield-alt"></i>
                            Permissions
                        </div>
                        <div class="permission-checkboxes">
                            <div v-for="permission in availablePermissions" :key="permission.id" class="form-check">
                                <input type="checkbox" class="form-check-input" 
                                       v-model="roleModal.form.permissions"
                                       :value="permission.id"
                                       :id="`permission-${permission.id}`">
                                <label class="form-check-label" :for="`permission-${permission.id}`">
                                    {{ formatPermissionName(permission.name) }}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="roleModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveRole" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else>{{ roleModal.mode === 'add' ? 'Add Role' : 'Save Changes' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- User Profile Modal -->
        <div v-if="userProfileModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="user-profile-title">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title" id="user-profile-title">
                        <i class="fas fa-user"></i> Profile Settings
                    </div>
                    <button class="modal-close" @click="userProfileModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-id-card"></i>
                            Personal Information
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" v-model="userProfileModal.form.full_name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" v-model="userProfileModal.form.email" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="text" class="form-control" v-model="userProfileModal.form.phone">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Department</label>
                                <select class="form-select" v-model="userProfileModal.form.department_id">
                                    <option value="">Select Department</option>
                                    <option v-for="department in departments" :key="department.id" :value="department.id">
                                        {{ department.name }}
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <i class="fas fa-bell"></i>
                            Notification Preferences
                        </div>
                        <div class="form-group">
                            <label class="form-check">
                                <input type="checkbox" class="form-check-input" v-model="userProfileModal.form.notifications_enabled">
                                <span class="form-check-label">Enable Email Notifications</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-check">
                                <input type="checkbox" class="form-check-input" v-model="userProfileModal.form.absence_notifications">
                                <span class="form-check-label">Staff Absence Notifications</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-check">
                                <input type="checkbox" class="form-check-input" v-model="userProfileModal.form.announcement_notifications">
                                <span class="form-check-label">Announcement Notifications</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="userProfileModal.show = false">Cancel</button>
                    <button class="btn btn-primary" @click="saveUserProfile" :disabled="saving">
                        <span v-if="saving" class="loading"></span>
                        <span v-else>Save Profile</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Absence Details Modal -->
        <div v-if="absenceDetailsModal.show" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="absence-details-title">
            <div class="modal-container modal-wide">
                <div class="modal-header">
                    <div class="modal-title" id="absence-details-title">
                        <i class="fas fa-calendar-times"></i>
                        Absence Record Details
                    </div>
                    <button class="modal-close" @click="absenceDetailsModal.show = false" aria-label="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="staff-profile-header">
                        <div class="staff-avatar-large" aria-hidden="true">{{ getInitials(getStaffName(absenceDetailsModal.absence.staff_member_id)) }}</div>
                        <div class="staff-basic-info">
                            <div class="staff-name">{{ getStaffName(absenceDetailsModal.absence.staff_member_id) }}</div>
                            <div class="staff-title">{{ formatAbsenceReason(absenceDetailsModal.absence.absence_reason) }}</div>
                            <span class="staff-status" :class="getAbsenceStatusClass(absenceDetailsModal.absence.status)">
                                {{ formatAbsenceStatus(absenceDetailsModal.absence.status) }}
                            </span>
                        </div>
                    </div>

                    <div class="staff-stats">
                        <div class="staff-stat-card">
                            <div class="staff-stat-value">{{ calculateAbsenceDuration(absenceDetailsModal.absence.start_date, absenceDetailsModal.absence.end_date) }}</div>
                            <div class="staff-stat-label">Total Days</div>
                        </div>
                        <div class="staff-stat-card">
                            <div class="staff-stat-value">{{ formatDate(absenceDetailsModal.absence.start_date) }}</div>
                            <div class="staff-stat-label">Start Date</div>
                        </div>
                        <div class="staff-stat-card">
                            <div class="staff-stat-value">{{ formatDate(absenceDetailsModal.absence.end_date) }}</div>
                            <div class="staff-stat-label">End Date</div>
                        </div>
                        <div class="staff-stat-card">
                            <div class="staff-stat-value">{{ absenceDetailsModal.absence.replacement_staff_id ? getStaffName(absenceDetailsModal.absence.replacement_staff_id) : 'No coverage' }}</div>
                            <div class="staff-stat-label">Coverage Assigned</div>
                        </div>
                    </div>

                    <div class="modal-tabs" role="tablist">
                        <button class="modal-tab" :class="{ active: absenceDetailsModal.activeTab === 'details' }" 
                                @click="absenceDetailsModal.activeTab = 'details'" role="tab" aria-selected="absenceDetailsModal.activeTab === 'details'">
                            <i class="fas fa-info-circle"></i> Absence Details
                        </button>
                        <button class="modal-tab" :class="{ active: absenceDetailsModal.activeTab === 'coverage' }" 
                                @click="absenceDetailsModal.activeTab = 'coverage'" role="tab" aria-selected="absenceDetailsModal.activeTab === 'coverage'">
                            <i class="fas fa-user-md"></i> Coverage Information
                        </button>
                        <button class="modal-tab" :class="{ active: absenceDetailsModal.activeTab === 'timeline' }" 
                                @click="absenceDetailsModal.activeTab = 'timeline'" role="tab" aria-selected="absenceDetailsModal.activeTab === 'timeline'">
                            <i class="fas fa-history"></i> Status Timeline
                        </button>
                    </div>

                    <!-- Details Tab -->
                    <div v-if="absenceDetailsModal.activeTab === 'details'" class="modal-tab-content active" role="tabpanel">
                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-file-medical"></i>
                                Absence Information
                            </div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Documented By</div>
                                    <div class="info-value">{{ absenceDetailsModal.absence.documented_by || 'System Administrator' }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Documentation Date</div>
                                    <div class="info-value">{{ formatDateTime(absenceDetailsModal.absence.created_at) }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Approval Status</div>
                                    <div class="info-value">
                                        <span class="badge" :class="getApprovalStatusClass(absenceDetailsModal.absence.approval_status)">
                                            {{ formatApprovalStatus(absenceDetailsModal.absence.approval_status) }}
                                        </span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Last Updated</div>
                                    <div class="info-value">{{ formatTimeAgo(absenceDetailsModal.absence.updated_at) }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-sticky-note"></i>
                                Notes & Documentation
                            </div>
                            <div class="info-item">
                                <div class="info-label">Additional Notes</div>
                                <div class="info-value" :class="absenceDetailsModal.absence.notes ? '' : 'unavailable'">
                                    {{ absenceDetailsModal.absence.notes || 'No additional notes provided' }}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Supporting Documentation</div>
                                <div class="info-value" :class="absenceDetailsModal.absence.supporting_docs ? '' : 'unavailable'">
                                    {{ absenceDetailsModal.absence.supporting_docs || 'No supporting documentation attached' }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coverage Tab -->
                    <div v-if="absenceDetailsModal.activeTab === 'coverage'" class="modal-tab-content active" role="tabpanel">
                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-user-shield"></i>
                                Coverage Arrangement
                            </div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Coverage Type</div>
                                    <div class="info-value">{{ absenceDetailsModal.absence.coverage_type || 'Standard coverage' }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Coverage Assigned</div>
                                    <div class="info-value" :class="absenceDetailsModal.absence.replacement_staff_id ? '' : 'unavailable'">
                                        {{ absenceDetailsModal.absence.replacement_staff_id ? getStaffName(absenceDetailsModal.absence.replacement_staff_id) : 'Coverage not yet assigned' }}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Coverage Contact</div>
                                    <div class="info-value" :class="absenceDetailsModal.absence.coverage_contact ? '' : 'unavailable'">
                                        {{ absenceDetailsModal.absence.coverage_contact || 'Contact information not available' }}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Coverage Start Date</div>
                                    <div class="info-value">{{ formatDate(absenceDetailsModal.absence.coverage_start_date) || 'Not specified' }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-clipboard-check"></i>
                                Coverage Instructions
                            </div>
                            <div class="info-item">
                                <div class="info-label">Clinical Coverage Notes</div>
                                <div class="info-value" :class="absenceDetailsModal.absence.coverage_instructions ? '' : 'unavailable'">
                                    {{ absenceDetailsModal.absence.coverage_instructions || 'No specific coverage instructions provided' }}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Emergency Contact Protocol</div>
                                <div class="info-value" :class="absenceDetailsModal.absence.emergency_protocol ? '' : 'unavailable'">
                                    {{ absenceDetailsModal.absence.emergency_protocol || 'Standard emergency protocols apply' }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline Tab -->
                    <div v-if="absenceDetailsModal.activeTab === 'timeline'" class="modal-tab-content active" role="tabpanel">
                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-stream"></i>
                                Absence Timeline
                            </div>
                            <div class="activity-timeline" style="position: relative; padding-left: 30px;">
                                <div style="position: absolute; left: 7px; top: 0; bottom: 0; width: 2px; background: var(--medical-light-blue);"></div>
                                
                                <div class="timeline-item" style="position: relative; padding-bottom: 25px;">
                                    <div style="position: absolute; left: -24px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--medical-blue); border: 3px solid white; box-shadow: 0 0 0 2px var(--medical-blue);"></div>
                                    <div style="background: var(--medical-light-blue); padding: 12px; border-radius: var(--border-radius-md); margin-bottom: 4px;">
                                        <div style="font-weight: 600; color: var(--medical-dark-blue);">Absence Documented</div>
                                        <div style="font-size: 13px; color: var(--medical-gray);">{{ formatDateTime(absenceDetailsModal.absence.created_at) }}</div>
                                    </div>
                                </div>

                                <div class="timeline-item" style="position: relative; padding-bottom: 25px;">
                                    <div style="position: absolute; left: -24px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--medical-teal); border: 3px solid white; box-shadow: 0 0 0 2px var(--medical-teal);"></div>
                                    <div style="background: var(--medical-light-blue); padding: 12px; border-radius: var(--border-radius-md); margin-bottom: 4px;">
                                        <div style="font-weight: 600; color: var(--medical-dark-blue);">Absence Period</div>
                                        <div style="font-size: 13px; color: var(--medical-gray);">
                                            {{ formatDate(absenceDetailsModal.absence.start_date) }} to {{ formatDate(absenceDetailsModal.absence.end_date) }}
                                            <span class="badge status-busy" style="margin-left: 8px;">{{ calculateAbsenceDuration(absenceDetailsModal.absence.start_date, absenceDetailsModal.absence.end_date) }} days</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="timeline-item" style="position: relative; padding-bottom: 25px;">
                                    <div style="position: absolute; left: -24px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--medical-green); border: 3px solid white; box-shadow: 0 0 0 2px var(--medical-green);"></div>
                                    <div style="background: var(--medical-light-blue); padding: 12px; border-radius: var(--border-radius-md); margin-bottom: 4px;">
                                        <div style="font-weight: 600; color: var(--medical-dark-blue);">Coverage Arranged</div>
                                        <div style="font-size: 13px; color: var(--medical-gray);" v-if="absenceDetailsModal.absence.replacement_staff_id">
                                            {{ getStaffName(absenceDetailsModal.absence.replacement_staff_id) }} assigned
                                        </div>
                                        <div style="font-size: 13px; color: var(--medical-gray);" v-else>
                                            No coverage assigned yet
                                        </div>
                                    </div>
                                </div>

                                <div class="timeline-item" style="position: relative;">
                                    <div style="position: absolute; left: -24px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--medical-orange); border: 3px solid white; box-shadow: 0 0 0 2px var(--medical-orange);"></div>
                                    <div style="background: var(--medical-light-blue); padding: 12px; border-radius: var(--border-radius-md);">
                                        <div style="font-weight: 600; color: var(--medical-dark-blue);">Current Status</div>
                                        <div style="font-size: 13px; color: var(--medical-gray);">
                                            <span class="badge" :class="getAbsenceStatusClass(absenceDetailsModal.absence.status)" style="margin-right: 8px;">
                                                {{ formatAbsenceStatus(absenceDetailsModal.absence.status) }}
                                            </span>
                                            {{ getAbsenceTimelineStatus(absenceDetailsModal.absence) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="absenceDetailsModal.show = false">Close</button>
                    <button class="btn btn-primary" @click="editAbsence(absenceDetailsModal.absence)"
                            v-if="hasPermission('staff_absence', 'update')">
                        <i class="fas fa-edit"></i> Edit Absence
                    </button>
                    <button class="btn btn-success" @click="assignCoverage(absenceDetailsModal.absence)"
                            v-if="hasPermission('staff_absence', 'update') && !absenceDetailsModal.absence.replacement_staff_id">
                        <i class="fas fa-user-md"></i> Assign Coverage
                    </button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div v-if="confirmationModal && confirmationModal.show" class="modal-overlay" role="dialog" aria-modal="true" 
             aria-labelledby="confirmation-title" aria-describedby="confirmation-message">
            <div class="modal-container" style="max-width: 500px;">
                <div class="modal-header">
                    <div class="modal-title" id="confirmation-title">
                        <i class="fas" :class="confirmationModal.icon || 'fa-question-circle'"></i>
                        {{ confirmationModal.title || 'Confirm Action' }}
                    </div>
                    <button class="modal-close" @click="cancelConfirmation" aria-label="Close confirmation dialog">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="confirmation-message" style="text-align: center; margin: 20px 0; font-size: 16px; color: var(--gray-700); line-height: 1.5;">
                        {{ confirmationModal.message || 'Are you sure you want to proceed?' }}
                    </p>
                    <div v-if="confirmationModal.details" style="background: var(--medical-light-blue); padding: 16px; border-radius: var(--border-radius-md); margin-top: 16px; font-size: 14px; color: var(--medical-dark-blue);">
                        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                        {{ confirmationModal.details }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="cancelConfirmation" :disabled="saving">
                        {{ confirmationModal.cancelButtonText || 'Cancel' }}
                    </button>
                    <button class="btn" :class="confirmationModal.confirmButtonClass || 'btn-danger'" @click="confirmAction" :disabled="saving">
                        <template v-if="saving">
                            <span class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;"></span>
                        </template>
                        <template v-else>
                            <i :class="confirmationModal.confirmButtonIcon || 'fa-check'" style="margin-right: 8px;"></i>
                            {{ confirmationModal.confirmButtonText || 'Confirm' }}
                        </template>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Load the main Vue application logic -->
        <script>
            // ============ VUE APPLICATION ============
            const { createApp, ref, reactive, computed, onMounted } = Vue;

            createApp({
                setup() {
                    // ============ API CONFIGURATION ============
                    const API_BASE_URL = 'https://restful-api-bacakend.up.railway.app/api'; // CHANGE THIS to your Railway URL
                    let authToken = localStorage.getItem('authToken');
                    
                    // API helper function
                    const api = {
                        async request(endpoint, options = {}) {
                            const url = `${API_BASE_URL}${endpoint}`;
                            const headers = {
                                'Content-Type': 'application/json',
                                ...options.headers
                            };
                            
                            if (authToken) {
                                headers['Authorization'] = `Bearer ${authToken}`;
                            }
                            
                            const response = await fetch(url, { ...options, headers });
                            
                            if (!response.ok) {
                                const error = await response.json().catch(() => ({ error: 'Network error' }));
                                throw new Error(error.error || `HTTP ${response.status}`);
                            }
                            
                            return response.json();
                        },
                        
                        // Authentication
                        login(email, password) {
                            return this.request('/auth/login', {
                                method: 'POST',
                                body: JSON.stringify({ email, password })
                            });
                        },
                        
                        // Dashboard
                        getDashboardStats() {
                            return this.request('/dashboard/stats');
                        },
                        
                        getTodayOnCall() {
                            return this.request('/dashboard/oncall-today');
                        },
                        
                        // Medical Staff
                        getMedicalStaff(filters = {}) {
                            const params = new URLSearchParams(filters).toString();
                            return this.request(`/medical-staff?${params}`);
                        },
                        
                        getMedicalStaffById(id) {
                            return this.request(`/medical-staff/${id}`);
                        },
                        
                        createMedicalStaff(data) {
                            return this.request('/medical-staff', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        updateMedicalStaff(id, data) {
                            return this.request(`/medical-staff/${id}`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        deleteMedicalStaff(id) {
                            return this.request(`/medical-staff/${id}`, {
                                method: 'DELETE'
                            });
                        },
                        
                        // Departments
                        getDepartments() {
                            return this.request('/departments');
                        },
                        
                        createDepartment(data) {
                            return this.request('/departments', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        updateDepartment(id, data) {
                            return this.request(`/departments/${id}`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        deleteDepartment(id) {
                            return this.request(`/departments/${id}`, {
                                method: 'DELETE'
                            });
                        },
                        
                        // Clinical Units
                        getClinicalUnits() {
                            return this.request('/clinical-units');
                        },
                        
                        createClinicalUnit(data) {
                            return this.request('/clinical-units', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        updateClinicalUnit(id, data) {
                            return this.request(`/clinical-units/${id}`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        deleteClinicalUnit(id) {
                            return this.request(`/clinical-units/${id}`, {
                                method: 'DELETE'
                            });
                        },
                        
                        // Training Units
                        getTrainingUnits() {
                            return this.request('/training-units');
                        },
                        
                        getTrainingUnitResidents(unitId) {
                            return this.request(`/training-units/${unitId}/residents`);
                        },
                        
                        createTrainingUnit(data) {
                            return this.request('/training-units', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        updateTrainingUnit(id, data) {
                            return this.request(`/training-units/${id}`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        // Rotations
                        getRotations(filters = {}) {
                            const params = new URLSearchParams(filters).toString();
                            return this.request(`/rotations?${params}`);
                        },
                        
                        getRotationById(id) {
                            return this.request(`/rotations/${id}`);
                        },
                        
                        createRotation(data) {
                            return this.request('/rotations', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        createQuickPlacement(data) {
                            return this.request('/rotations/quick-placement', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        createBulkAssignment(data) {
                            return this.request('/rotations/bulk-assign', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        updateRotation(id, data) {
                            return this.request(`/rotations/${id}`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        deleteRotation(id) {
                            return this.request(`/rotations/${id}`, {
                                method: 'DELETE'
                            });
                        },
                        
                        // On-call Schedule
                        getOnCallSchedule(filters = {}) {
                            const params = new URLSearchParams(filters).toString();
                            return this.request(`/oncall?${params}`);
                        },
                        
                        createOnCallSchedule(data) {
                            return this.request('/oncall', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        updateOnCallSchedule(id, data) {
                            return this.request(`/oncall/${id}`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        deleteOnCallSchedule(id) {
                            return this.request(`/oncall/${id}`, {
                                method: 'DELETE'
                            });
                        },
                        
                        // Staff Absences
                        getAbsences(filters = {}) {
                            const params = new URLSearchParams(filters).toString();
                            return this.request(`/absences?${params}`);
                        },
                        
                        getAbsenceById(id) {
                            return this.request(`/absences/${id}`);
                        },
                        
                        createAbsence(data) {
                            return this.request('/absences', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        updateAbsence(id, data) {
                            return this.request(`/absences/${id}`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        updateAbsenceCoverage(id, data) {
                            return this.request(`/absences/${id}/coverage`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        deleteAbsence(id) {
                            return this.request(`/absences/${id}`, {
                                method: 'DELETE'
                            });
                        },
                        
                        // Communications
                        getAnnouncements() {
                            return this.request('/announcements');
                        },
                        
                        createAnnouncement(data) {
                            return this.request('/announcements', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        updateCapacity(data) {
                            return this.request('/capacity', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        // Audit Logs
                        getAuditLogs(filters = {}) {
                            const params = new URLSearchParams(filters).toString();
                            return this.request(`/audit-logs?${params}`);
                        },
                        
                        // System Settings
                        getSystemSettings() {
                            return this.request('/settings');
                        },
                        
                        updateSystemSettings(data) {
                            return this.request('/settings', {
                                method: 'PUT',
                                body: JSON.stringify(data)
                            });
                        },
                        
                        // Permissions
                        getPermissions() {
                            return this.request('/permissions');
                        },
                        
                        // Users
                        getUsers() {
                            return this.request('/users');
                        },
                        
                        // Live Stats
                        getLiveStats() {
                            return this.request('/live-stats');
                        }
                    };

                    // ============ APPLICATION STATE ============
                    const currentUser = ref(null);
                    const loading = ref(false);
                    const saving = ref(false);
                    const currentView = ref('daily_operations');
                    const sidebarCollapsed = ref(false);
                    const mobileMenuOpen = ref(false);
                    const statsSidebarOpen = ref(false);
                    const userMenuOpen = ref(false);
                    
                    // Data stores
                    const medicalStaff = ref([]);
                    const departments = ref([]);
                    const clinicalUnits = ref([]);
                    const trainingUnits = ref([]);
                    const rotations = ref([]);
                    const onCallSchedule = ref([]);
                    const absences = ref([]);
                    const recentAnnouncements = ref([]);
                    const auditLogs = ref([]);
                    const users = ref([]);
                    const userRoles = ref([]);
                    const availablePermissions = ref([]);
                    
                    // Dashboard data
                    const stats = reactive({
                        totalStaff: 0,
                        activePatients: 0,
                        todayAppointments: 0,
                        pendingAlerts: 0
                    });
                    
                    const liveStats = reactive({
                        occupancy: 0,
                        occupancyTrend: 0,
                        onDutyStaff: 0,
                        staffTrend: 0,
                        pendingRequests: 0,
                        erCapacity: { current: 0, max: 0, status: 'normal' },
                        icuCapacity: { current: 0, max: 0, status: 'normal' }
                    });
                    
                    const todaysOnCall = ref([]);
                    const loadingStats = ref(false);
                    const loadingSchedule = ref(false);
                    const loadingStaff = ref(false);
                    const loadingAnnouncements = ref(false);
                    
                    // System settings
                    const systemSettings = reactive({
                        hospital_name: 'NeumoCare Hospital',
                        default_department_id: null,
                        max_residents_per_unit: 10,
                        default_rotation_duration: 12,
                        enable_audit_logging: true,
                        require_mfa: false,
                        maintenance_mode: false,
                        notifications_enabled: true,
                        absence_notifications: true,
                        announcement_notifications: true
                    });
                    
                    // Login form
                    const loginForm = reactive({
                        email: '',
                        password: '',
                        remember_me: false
                    });
                    
                    // Modals
                    const medicalStaffModal = reactive({
                        show: false,
                        mode: 'add',
                        activeTab: 'basic',
                        form: {
                            full_name: '',
                            staff_type: 'medical_resident',
                            staff_id: '',
                            employment_status: 'active',
                            professional_email: '',
                            department_id: null,
                            office_phone: '',
                            mobile_phone: '',
                            medical_license: '',
                            date_of_birth: '',
                            years_experience: 0,
                            specialization: '',
                            resident_category: '',
                            training_level: '',
                            biography: ''
                        }
                    });
                    
                    const staffDetailsModal = reactive({
                        show: false,
                        staff: {},
                        stats: {},
                        activeTab: 'personal',
                        currentRotation: '',
                        nextOncall: '',
                        activityHistory: []
                    });
                    
                    const departmentModal = reactive({
                        show: false,
                        mode: 'add',
                        form: {
                            name: '',
                            code: '',
                            status: 'active',
                            head_of_department_id: null,
                            description: ''
                        }
                    });
                    
                    const clinicalUnitModal = reactive({
                        show: false,
                        mode: 'add',
                        form: {
                            name: '',
                            code: '',
                            department_id: null,
                            unit_type: 'clinical',
                            status: 'active',
                            supervisor_id: null,
                            description: ''
                        }
                    });
                    
                    const trainingUnitModal = reactive({
                        show: false,
                        mode: 'add',
                        form: {
                            name: '',
                            department_id: null,
                            supervisor_id: null,
                            max_capacity: 10,
                            status: 'active',
                            description: ''
                        }
                    });
                    
                    const rotationModal = reactive({
                        show: false,
                        mode: 'add',
                        form: {
                            resident_id: null,
                            training_unit_id: null,
                            start_date: '',
                            end_date: '',
                            supervisor_id: null,
                            status: 'active',
                            goals: '',
                            notes: ''
                        }
                    });
                    
                    const rotationDetailsModal = reactive({
                        show: false,
                        rotation: {},
                        activeTab: 'details',
                        milestones: [],
                        competencies: [],
                        documents: [],
                        activity: []
                    });
                    
                    const onCallModal = reactive({
                        show: false,
                        mode: 'add',
                        form: {
                            duty_date: '',
                            shift_type: 'primary_call',
                            start_time: '',
                            end_time: '',
                            primary_physician_id: null,
                            backup_physician_id: null,
                            coverage_notes: ''
                        }
                    });
                    
                    const absenceModal = reactive({
                        show: false,
                        mode: 'add',
                        form: {
                            staff_member_id: null,
                            absence_reason: '',
                            start_date: '',
                            end_date: '',
                            notes: '',
                            replacement_staff_id: null,
                            coverage_instructions: ''
                        }
                    });
                    
                    const absenceDetailsModal = reactive({
                        show: false,
                        absence: {},
                        activeTab: 'details'
                    });
                    
                    const quickPlacementModal = reactive({
                        show: false,
                        resident_id: null,
                        training_unit_id: null,
                        start_date: '',
                        duration: 4,
                        supervisor_id: null,
                        notes: ''
                    });
                    
                    const bulkAssignModal = reactive({
                        show: false,
                        selectedResidents: [],
                        training_unit_id: null,
                        start_date: '',
                        duration: 4,
                        supervisor_id: null
                    });
                    
                    const communicationsModal = reactive({
                        show: false,
                        activeTab: 'announcement',
                        form: {
                            announcement_title: '',
                            announcement_content: '',
                            publish_start_date: '',
                            publish_end_date: '',
                            priority_level: 'medium',
                            target_audience: 'all'
                        },
                        capacity: {
                            er: { current: 0, max: 20, notes: '' },
                            icu: { current: 0, max: 10, notes: '' },
                            overall_notes: ''
                        },
                        quickUpdate: {
                            message: '',
                            priority: 'info',
                            expires: '24',
                            tags: ''
                        }
                    });
                    
                    const roleModal = reactive({
                        show: false,
                        mode: 'add',
                        form: {
                            name: '',
                            description: '',
                            permissions: []
                        }
                    });
                    
                    const userProfileModal = reactive({
                        show: false,
                        form: {
                            full_name: '',
                            email: '',
                            phone: '',
                            department_id: null,
                            notifications_enabled: true,
                            absence_notifications: true,
                            announcement_notifications: true
                        }
                    });
                    
                    const confirmationModal = ref(null);
                    
                    // Toasts
                    const toasts = ref([]);
                    
                    // Search and filters
                    const searchQuery = ref('');
                    const searchScope = ref('Global');
                    const searchFilter = ref('all');
                    const staffSearch = ref('');
                    const staffFilter = reactive({
                        staff_type: '',
                        employment_status: ''
                    });
                    const rotationFilter = reactive({
                        resident_id: '',
                        status: '',
                        training_unit_id: ''
                    });
                    const absenceFilter = reactive({
                        staff_id: '',
                        status: '',
                        start_date: ''
                    });
                    const auditFilters = reactive({
                        dateRange: '',
                        actionType: '',
                        userId: ''
                    });
                    
                    // Alerts
                    const activeAlerts = ref([]);
                    const unreadNotifications = ref(0);
                    
                    // Current capacity
                    const currentCapacity = reactive({
                        er: { current: 12, max: 20, status: 'medium' },
                        icu: { current: 6, max: 10, status: 'low' }
                    });
                    
                    // ============ COMPUTED PROPERTIES ============
                    const filteredMedicalStaff = computed(() => {
                        return medicalStaff.value.filter(staff => {
                            const matchesSearch = !staffSearch.value || 
                                staff.full_name.toLowerCase().includes(staffSearch.value.toLowerCase()) ||
                                staff.staff_id.toLowerCase().includes(staffSearch.value.toLowerCase()) ||
                                staff.professional_email.toLowerCase().includes(staffSearch.value.toLowerCase());
                            
                            const matchesType = !staffFilter.staff_type || staff.staff_type === staffFilter.staff_type;
                            const matchesStatus = !staffFilter.employment_status || staff.employment_status === staffFilter.employment_status;
                            
                            return matchesSearch && matchesType && matchesStatus;
                        });
                    });
                    
                    const filteredRotations = computed(() => {
                        return rotations.value.filter(rotation => {
                            const matchesResident = !rotationFilter.resident_id || rotation.resident_id === rotationFilter.resident_id;
                            const matchesStatus = !rotationFilter.status || rotation.status === rotationFilter.status;
                            const matchesUnit = !rotationFilter.training_unit_id || rotation.training_unit_id === rotationFilter.training_unit_id;
                            
                            return matchesResident && matchesStatus && matchesUnit;
                        });
                    });
                    
                    const filteredAbsences = computed(() => {
                        return absences.value.filter(absence => {
                            const matchesStaff = !absenceFilter.staff_id || absence.staff_member_id === absenceFilter.staff_id;
                            const matchesStatus = !absenceFilter.status || absence.status === absenceFilter.status;
                            const matchesDate = !absenceFilter.start_date || absence.start_date >= absenceFilter.start_date;
                            
                            return matchesStaff && matchesStatus && matchesDate;
                        });
                    });
                    
                    const filteredAuditLogs = computed(() => {
                        return auditLogs.value.filter(log => {
                            const matchesDate = !auditFilters.dateRange || 
                                new Date(log.created_at).toISOString().split('T')[0] === auditFilters.dateRange;
                            const matchesAction = !auditFilters.actionType || log.action === auditFilters.actionType;
                            const matchesUser = !auditFilters.userId || log.user_id === auditFilters.userId;
                            
                            return matchesDate && matchesAction && matchesUser;
                        });
                    });
                    
                    const availableHeadsOfDepartment = computed(() => {
                        return medicalStaff.value.filter(staff => 
                            staff.staff_type === 'attending_physician' && 
                            staff.employment_status === 'active'
                        );
                    });
                    
                    const availableSupervisors = computed(() => {
                        return medicalStaff.value.filter(staff => 
                            staff.staff_type === 'attending_physician' && 
                            staff.employment_status === 'active'
                        );
                    });
                    
                    const availableAttendings = computed(() => {
                        return medicalStaff.value.filter(staff => 
                            staff.staff_type === 'attending_physician' && 
                            staff.employment_status === 'active'
                        );
                    });
                    
                    const availablePhysicians = computed(() => {
                        return medicalStaff.value.filter(staff => 
                            (staff.staff_type === 'attending_physician' || staff.staff_type === 'fellow') && 
                            staff.employment_status === 'active'
                        );
                    });
                    
                    const availableResidents = computed(() => {
                        return medicalStaff.value.filter(staff => 
                            staff.staff_type === 'medical_resident' && 
                            staff.employment_status === 'active'
                        );
                    });
                    
                    const availableStaff = computed(() => {
                        return medicalStaff.value.filter(staff => 
                            staff.employment_status === 'active'
                        );
                    });
                    
                    const availableCoverageStaff = computed(() => {
                        return medicalStaff.value.filter(staff => 
                            staff.employment_status === 'active' &&
                            staff.staff_type !== 'medical_resident'
                        );
                    });
                    
                    const availableTrainingUnits = computed(() => {
                        return trainingUnits.value.filter(unit => 
                            unit.status === 'active'
                        );
                    });
                    
                    const residents = computed(() => {
                        return medicalStaff.value.filter(staff => 
                            staff.staff_type === 'medical_resident'
                        );
                    });
                    
                    // ============ HELPER FUNCTIONS ============
                    function getInitials(name) {
                        if (!name) return '??';
                        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                    }
                    
                    function formatDateTime(dateString) {
                        if (!dateString) return 'N/A';
                        const date = new Date(dateString);
                        return date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    
                    function formatDate(dateString) {
                        if (!dateString) return 'N/A';
                        const date = new Date(dateString);
                        return date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    }
                    
                    function formatTimeAgo(dateString) {
                        if (!dateString) return 'Never';
                        const date = new Date(dateString);
                        const now = new Date();
                        const diffMs = now - date;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMs / 3600000);
                        const diffDays = Math.floor(diffMs / 86400000);
                        
                        if (diffMins < 1) return 'Just now';
                        if (diffMins < 60) return `${diffMins}m ago`;
                        if (diffHours < 24) return `${diffHours}h ago`;
                        if (diffDays < 30) return `${diffDays}d ago`;
                        
                        return formatDate(dateString);
                    }
                    
                    function formatStaffType(type) {
                        const types = {
                            'medical_resident': 'Medical Resident',
                            'attending_physician': 'Attending Physician',
                            'fellow': 'Fellow',
                            'nurse_practitioner': 'Nurse Practitioner'
                        };
                        return types[type] || type;
                    }
                    
                    function getStaffTypeClass(type) {
                        const classes = {
                            'medical_resident': 'badge-info',
                            'attending_physician': 'badge-primary',
                            'fellow': 'badge-warning',
                            'nurse_practitioner': 'badge-success'
                        };
                        return classes[type] || 'badge-info';
                    }
                    
                    function formatEmploymentStatus(status) {
                        const statuses = {
                            'active': 'Active',
                            'on_leave': 'On Leave',
                            'inactive': 'Inactive'
                        };
                        return statuses[status] || status;
                    }
                    
                    function getDepartmentName(departmentId) {
                        if (!departmentId) return '';
                        const dept = departments.value.find(d => d.id === departmentId);
                        return dept ? dept.name : '';
                    }
                    
                    function getDepartmentUnits(departmentId) {
                        if (!departmentId) return [];
                        return clinicalUnits.value.filter(unit => unit.department_id === departmentId);
                    }
                    
                    function formatTrainingLevel(level) {
                        const levels = {
                            'pgy1': 'PGY-1',
                            'pgy2': 'PGY-2',
                            'pgy3': 'PGY-3',
                            'pgy4': 'PGY-4',
                            'other': 'Other'
                        };
                        return levels[level] || level;
                    }
                    
                    function formatResidentCategory(category) {
                        const categories = {
                            'department_internal': 'Department Internal',
                            'rotating_other_dept': 'Rotating Other Dept',
                            'external_institution': 'External Institution'
                        };
                        return categories[category] || category;
                    }
                    
                    function getResidentName(residentId) {
                        if (!residentId) return 'Unknown';
                        const resident = medicalStaff.value.find(staff => staff.id === residentId);
                        return resident ? resident.full_name : 'Unknown';
                    }
                    
                    function getTrainingUnitName(unitId) {
                        if (!unitId) return 'Unknown';
                        const unit = trainingUnits.value.find(u => u.id === unitId);
                        return unit ? unit.name : 'Unknown';
                    }
                    
                    function getSupervisorName(supervisorId) {
                        if (!supervisorId) return null;
                        const supervisor = medicalStaff.value.find(staff => staff.id === supervisorId);
                        return supervisor ? supervisor.full_name : null;
                    }
                    
                    function formatRotationStatus(status) {
                        const statuses = {
                            'active': 'Active',
                            'upcoming': 'Upcoming',
                            'completed': 'Completed',
                            'cancelled': 'Cancelled'
                        };
                        return statuses[status] || status;
                    }
                    
                    function getRotationStatusClass(status) {
                        const classes = {
                            'active': 'status-available',
                            'upcoming': 'status-busy',
                            'completed': 'status-critical',
                            'cancelled': 'badge-danger'
                        };
                        return classes[status] || 'badge-info';
                    }
                    
                    function getUnitResidents(unitId) {
                        if (!unitId) return [];
                        const unitRotations = rotations.value.filter(r => 
                            r.training_unit_id === unitId && 
                            r.status === 'active'
                        );
                        return unitRotations.map(rotation => {
                            const resident = medicalStaff.value.find(staff => staff.id === rotation.resident_id);
                            return resident ? {
                                id: resident.id,
                                full_name: resident.full_name,
                                training_level: resident.training_level
                            } : null;
                        }).filter(r => r !== null);
                    }
                    
                    function formatAbsenceReason(reason) {
                        const reasons = {
                            'vacation': 'Vacation',
                            'sick_leave': 'Sick Leave',
                            'conference': 'Conference/Education',
                            'personal': 'Personal',
                            'maternity_paternity': 'Maternity/Paternity',
                            'administrative': 'Administrative Duty',
                            'other': 'Other'
                        };
                        return reasons[reason] || reason;
                    }
                    
                    function calculateAbsenceDuration(startDate, endDate) {
                        if (!startDate || !endDate) return 0;
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        const diffTime = Math.abs(end - start);
                        return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    }
                    
                    function getAbsenceStatusClass(status) {
                        const classes = {
                            'active': 'status-busy',
                            'upcoming': 'status-busy',
                            'completed': 'status-available',
                            'cancelled': 'badge-danger'
                        };
                        return classes[status] || 'badge-info';
                    }
                    
                    function formatAbsenceStatus(status) {
                        const statuses = {
                            'active': 'Active',
                            'upcoming': 'Upcoming',
                            'completed': 'Completed',
                            'cancelled': 'Cancelled'
                        };
                        return statuses[status] || status;
                    }
                    
                    function getStaffName(staffId) {
                        if (!staffId) return 'Unknown';
                        const staff = medicalStaff.value.find(s => s.id === staffId);
                        return staff ? staff.full_name : 'Unknown';
                    }
                    
                    function formatAuditAction(action) {
                        const actions = {
                            'create': 'Created',
                            'update': 'Updated',
                            'delete': 'Deleted',
                            'login': 'Logged In',
                            'logout': 'Logged Out'
                        };
                        return actions[action] || action;
                    }
                    
                    function getUserName(userId) {
                        if (!userId) return 'System';
                        const user = users.value.find(u => u.id === userId);
                        return user ? user.full_name : `User ${userId}`;
                    }
                    
                    function formatPermissionName(permission) {
                        return permission.replace('_', ' ').replace('.', ' - ');
                    }
                    
                    function roleHasPermission(roleId, permissionId) {
                        const role = userRoles.value.find(r => r.id === roleId);
                        if (!role || !role.permissions) return false;
                        return role.permissions.includes(permissionId);
                    }
                    
                    function getUserPermissions(userId) {
                        const user = users.value.find(u => u.id === userId);
                        if (!user) return [];
                        const role = userRoles.value.find(r => r.name === user.user_role);
                        return role ? role.permissions || [] : [];
                    }
                    
                    function getUserRoleDisplay(role) {
                        const roles = {
                            'system_admin': 'System Administrator',
                            'department_head': 'Department Head',
                            'resident_manager': 'Resident Manager'
                        };
                        return roles[role] || role;
                    }
                    
                    function hasPermission(resource, action) {
                        if (!currentUser.value) return false;
                        
                        const permissions = {
                            'system_admin': { all: true },
                            'department_head': {
                                'medical_staff': ['read', 'create', 'update'],
                                'training_units': ['read', 'create', 'update', 'assign'],
                                'resident_rotations': ['read', 'create', 'update'],
                                'oncall_schedule': ['read', 'create', 'update'],
                                'staff_absence': ['read', 'create', 'update', 'delete'],
                                'communications': ['read', 'create', 'update', 'delete']
                            },
                            'resident_manager': {
                                'medical_staff': ['read', 'create', 'update'],
                                'training_units': ['read', 'create', 'update', 'assign'],
                                'resident_rotations': ['read', 'create', 'update'],
                                'staff_absence': ['read', 'create']
                            }
                        };
                        
                        const userRole = currentUser.value.user_role;
                        const rolePerms = permissions[userRole];
                        
                        if (!rolePerms) return false;
                        if (rolePerms.all === true) return true;
                        if (rolePerms[resource] && rolePerms[resource].includes(action)) return true;
                        
                        return false;
                    }
                    
                    function getCurrentTitle() {
                        const titles = {
                            'daily_operations': 'Daily Operations Dashboard',
                            'medical_staff': 'Medical Staff Management',
                            'department_management': 'Department Management',
                            'training_units': 'Training Units Management',
                            'resident_rotations': 'Resident Rotations',
                            'staff_absence': 'Staff Absence Management',
                            'communications': 'Department Communications',
                            'audit_logs': 'Audit Logs',
                            'permission_manager': 'Permission Manager',
                            'system_settings': 'System Settings'
                        };
                        return titles[currentView.value] || 'NeumoCare HMS';
                    }
                    
                    function getCurrentSubtitle() {
                        const subtitles = {
                            'daily_operations': 'Overview and quick actions',
                            'medical_staff': 'Manage all medical staff',
                            'department_management': 'Organizational structure',
                            'training_units': 'Clinical training assignments',
                            'resident_rotations': 'Resident schedules and assignments',
                            'staff_absence': 'Track and manage staff leave',
                            'communications': 'Announcements and updates',
                            'audit_logs': 'System activity tracking',
                            'permission_manager': 'Access control management',
                            'system_settings': 'System configuration'
                        };
                        return subtitles[currentView.value] || '';
                    }
                    
                    function getSearchPlaceholder() {
                        const placeholders = {
                            'daily_operations': 'Search staff, patients, units...',
                            'medical_staff': 'Search medical staff...',
                            'department_management': 'Search departments, units...',
                            'training_units': 'Search training units...',
                            'resident_rotations': 'Search rotations...',
                            'staff_absence': 'Search absences...',
                            'communications': 'Search announcements...',
                            'audit_logs': 'Search audit logs...',
                            'permission_manager': 'Search permissions...',
                            'system_settings': 'Search settings...'
                        };
                        return placeholders[currentView.value] || 'Search...';
                    }
                    
                    function getPriorityColor(priority) {
                        const colors = {
                            'low': 'info',
                            'medium': 'warning',
                            'high': 'danger',
                            'urgent': 'danger'
                        };
                        return colors[priority] || 'info';
                    }
                    
                    function getCapacityStatus(capacity) {
                        const percentage = (capacity.current / capacity.max) * 100;
                        if (percentage < 60) return 'low';
                        if (percentage < 85) return 'medium';
                        return 'high';
                    }
                    
                    function formatTimeRange(start, end) {
                        if (!start || !end) return 'N/A';
                        return `${start} - ${end}`;
                    }
                    
                    // ============ TOAST FUNCTIONS ============
                    function showToast(type, title, message) {
                        const id = Date.now();
                        const icons = {
                            'success': 'fa-check-circle',
                            'error': 'fa-exclamation-circle',
                            'warning': 'fa-exclamation-triangle',
                            'info': 'fa-info-circle'
                        };
                        
                        toasts.value.push({
                            id,
                            type,
                            title,
                            message,
                            icon: icons[type] || 'fa-info-circle'
                        });
                        
                        setTimeout(() => {
                            removeToast(id);
                        }, 5000);
                    }
                    
                    function removeToast(id) {
                        const index = toasts.value.findIndex(t => t.id === id);
                        if (index !== -1) {
                            toasts.value.splice(index, 1);
                        }
                    }
                    
                    // ============ CONFIRMATION MODAL FUNCTIONS ============
                    function showConfirmation(config) {
                        confirmationModal.value = {
                            show: true,
                            title: config.title || 'Confirm Action',
                            message: config.message || 'Are you sure you want to proceed?',
                            details: config.details || null,
                            icon: config.icon || 'fa-question-circle',
                            cancelButtonText: config.cancelButtonText || 'Cancel',
                            confirmButtonText: config.confirmButtonText || 'Confirm',
                            confirmButtonIcon: config.confirmButtonIcon || 'fa-check',
                            confirmButtonClass: config.confirmButtonClass || 'btn-danger',
                            onConfirm: config.onConfirm,
                            onCancel: config.onCancel
                        };
                    }
                    
                    function cancelConfirmation() {
                        if (confirmationModal.value && confirmationModal.value.onCancel) {
                            confirmationModal.value.onCancel();
                        }
                        confirmationModal.value = null;
                    }
                    
                    function confirmAction() {
                        if (confirmationModal.value && confirmationModal.value.onConfirm) {
                            confirmationModal.value.onConfirm();
                        }
                        confirmationModal.value = null;
                    }
                    
                    // ============ ACTION MENU FUNCTIONS ============
                    function toggleActionMenu(event) {
                        event.stopPropagation();
                        const menu = event.target.closest('.action-dropdown').querySelector('.action-menu');
                        const isShowing = menu.classList.contains('show');
                        
                        // Close all other menus
                        document.querySelectorAll('.action-menu.show').forEach(m => {
                            m.classList.remove('show');
                        });
                        
                        if (!isShowing) {
                            menu.classList.add('show');
                            // Close on outside click
                            const clickHandler = (e) => {
                                if (!menu.contains(e.target) && !event.target.contains(e.target)) {
                                    menu.classList.remove('show');
                                    document.removeEventListener('click', clickHandler);
                                }
                            };
                            setTimeout(() => {
                                document.addEventListener('click', clickHandler);
                            }, 10);
                        }
                    }
                    
                    function toggleUserMenu() {
                        userMenuOpen.value = !userMenuOpen.value;
                        if (userMenuOpen.value) {
                            // Close on outside click
                            setTimeout(() => {
                                const clickHandler = (e) => {
                                    if (!e.target.closest('.user-menu')) {
                                        userMenuOpen.value = false;
                                        document.removeEventListener('click', clickHandler);
                                    }
                                };
                                document.addEventListener('click', clickHandler);
                            }, 10);
                        }
                    }
                    
                    // ============ DATA LOADING FUNCTIONS ============
                    async function loadDashboardData() {
                        try {
                            loadingStats.value = true;
                            loadingSchedule.value = true;
                            loadingAnnouncements.value = true;
                            
                            const [statsData, scheduleData, announcementsData, liveStatsData] = await Promise.all([
                                api.getDashboardStats(),
                                api.getTodayOnCall(),
                                api.getAnnouncements(),
                                api.getLiveStats()
                            ]);
                            
                            Object.assign(stats, statsData);
                            todaysOnCall.value = scheduleData;
                            recentAnnouncements.value = announcementsData.slice(0, 5);
                            Object.assign(liveStats, liveStatsData);
                        } catch (error) {
                            console.error('Error loading dashboard data:', error);
                            showToast('error', 'Load Error', 'Failed to load dashboard data');
                        } finally {
                            loadingStats.value = false;
                            loadingSchedule.value = false;
                            loadingAnnouncements.value = false;
                        }
                    }
                    
                    async function loadMedicalStaff() {
                        try {
                            loadingStaff.value = true;
                            const data = await api.getMedicalStaff();
                            medicalStaff.value = data;
                        } catch (error) {
                            console.error('Error loading medical staff:', error);
                            showToast('error', 'Load Error', 'Failed to load medical staff');
                        } finally {
                            loadingStaff.value = false;
                        }
                    }
                    
                    async function loadDepartments() {
                        try {
                            const data = await api.getDepartments();
                            departments.value = data;
                        } catch (error) {
                            console.error('Error loading departments:', error);
                            showToast('error', 'Load Error', 'Failed to load departments');
                        }
                    }
                    
                    async function loadClinicalUnits() {
                        try {
                            const data = await api.getClinicalUnits();
                            clinicalUnits.value = data;
                        } catch (error) {
                            console.error('Error loading clinical units:', error);
                            showToast('error', 'Load Error', 'Failed to load clinical units');
                        }
                    }
                    
                    async function loadTrainingUnits() {
                        try {
                            const data = await api.getTrainingUnits();
                            trainingUnits.value = data;
                            
                            // Load residents for each unit
                            for (const unit of trainingUnits.value) {
                                try {
                                    const residents = await api.getTrainingUnitResidents(unit.id);
                                    unit.current_residents = residents.length;
                                } catch (err) {
                                    unit.current_residents = 0;
                                }
                            }
                        } catch (error) {
                            console.error('Error loading training units:', error);
                            showToast('error', 'Load Error', 'Failed to load training units');
                        }
                    }
                    
                    async function loadRotations() {
                        try {
                            const data = await api.getRotations();
                            rotations.value = data;
                        } catch (error) {
                            console.error('Error loading rotations:', error);
                            showToast('error', 'Load Error', 'Failed to load rotations');
                        }
                    }
                    
                    async function loadOnCallSchedule() {
                        try {
                            const today = new Date().toISOString().split('T')[0];
                            const data = await api.getOnCallSchedule({ start_date: today });
                            onCallSchedule.value = data;
                        } catch (error) {
                            console.error('Error loading on-call schedule:', error);
                            showToast('error', 'Load Error', 'Failed to load on-call schedule');
                        }
                    }
                    
                    async function loadAbsences() {
                        try {
                            const data = await api.getAbsences();
                            absences.value = data;
                        } catch (error) {
                            console.error('Error loading absences:', error);
                            showToast('error', 'Load Error', 'Failed to load absences');
                        }
                    }
                    
                    async function loadAuditLogs() {
                        try {
                            const data = await api.getAuditLogs();
                            auditLogs.value = data;
                        } catch (error) {
                            console.error('Error loading audit logs:', error);
                            showToast('error', 'Load Error', 'Failed to load audit logs');
                        }
                    }
                    
                    async function loadUsers() {
                        try {
                            const data = await api.getUsers();
                            users.value = data;
                        } catch (error) {
                            console.error('Error loading users:', error);
                            showToast('error', 'Load Error', 'Failed to load users');
                        }
                    }
                    
                    async function loadPermissions() {
                        try {
                            const data = await api.getPermissions();
                            userRoles.value = data.roles;
                            availablePermissions.value = data.permissions;
                        } catch (error) {
                            console.error('Error loading permissions:', error);
                            showToast('error', 'Load Error', 'Failed to load permissions');
                        }
                    }
                    
                    async function loadSystemSettings() {
                        try {
                            const data = await api.getSystemSettings();
                            Object.assign(systemSettings, data);
                        } catch (error) {
                            console.error('Error loading system settings:', error);
                        }
                    }
                    
                    // ============ VIEW SWITCHING ============
                    function switchView(view) {
                        currentView.value = view;
                        mobileMenuOpen.value = false;
                        
                        // Load data for the view
                        switch(view) {
                            case 'daily_operations':
                                loadDashboardData();
                                break;
                            case 'medical_staff':
                                loadMedicalStaff();
                                break;
                            case 'department_management':
                                loadDepartments();
                                loadClinicalUnits();
                                break;
                            case 'training_units':
                                loadTrainingUnits();
                                break;
                            case 'resident_rotations':
                                loadRotations();
                                break;
                            case 'staff_absence':
                                loadAbsences();
                                break;
                            case 'communications':
                                // Announcements already loaded
                                break;
                            case 'audit_logs':
                                loadAuditLogs();
                                break;
                            case 'permission_manager':
                                loadUsers();
                                loadPermissions();
                                break;
                            case 'system_settings':
                                loadSystemSettings();
                                break;
                        }
                    }
                    
                    // ============ AUTHENTICATION ============
                    async function handleLogin() {
                        try {
                            loading.value = true;
                            const result = await api.login(loginForm.email, loginForm.password);
                            
                            authToken = result.token;
                            localStorage.setItem('authToken', result.token);
                            
                            currentUser.value = result.user;
                            
                            if (loginForm.remember_me) {
                                localStorage.setItem('rememberedEmail', loginForm.email);
                            }
                            
                            showToast('success', 'Login Successful', 'Welcome to NeumoCare HMS');
                            loadDashboardData();
                        } catch (error) {
                            showToast('error', 'Login Failed', error.message || 'Invalid credentials');
                        } finally {
                            loading.value = false;
                        }
                    }
                    
                    function handleLogout() {
                        showConfirmation({
                            title: 'Confirm Logout',
                            message: 'Are you sure you want to logout?',
                            onConfirm: () => {
                                localStorage.removeItem('authToken');
                                currentUser.value = null;
                                authToken = null;
                                showToast('success', 'Logged Out', 'You have been logged out successfully');
                            }
                        });
                    }
                    
                    // ============ MODAL FUNCTIONS ============
                    function showAddMedicalStaffModal() {
                        medicalStaffModal.mode = 'add';
                        medicalStaffModal.form = {
                            full_name: '',
                            staff_type: 'medical_resident',
                            staff_id: '',
                            employment_status: 'active',
                            professional_email: '',
                            department_id: null,
                            office_phone: '',
                            mobile_phone: '',
                            medical_license: '',
                            date_of_birth: '',
                            years_experience: 0,
                            specialization: '',
                            resident_category: '',
                            training_level: '',
                            biography: ''
                        };
                        medicalStaffModal.activeTab = 'basic';
                        medicalStaffModal.show = true;
                    }
                    
                    async function saveMedicalStaff() {
                        try {
                            saving.value = true;
                            
                            if (medicalStaffModal.mode === 'add') {
                                const result = await api.createMedicalStaff(medicalStaffModal.form);
                                medicalStaff.value.push(result);
                                showToast('success', 'Success', 'Medical staff added successfully');
                            } else {
                                const result = await api.updateMedicalStaff(medicalStaffModal.form.id, medicalStaffModal.form);
                                const index = medicalStaff.value.findIndex(s => s.id === result.id);
                                if (index !== -1) {
                                    medicalStaff.value[index] = result;
                                }
                                showToast('success', 'Success', 'Medical staff updated successfully');
                            }
                            
                            medicalStaffModal.show = false;
                        } catch (error) {
                            showToast('error', 'Save Failed', error.message || 'Failed to save medical staff');
                        } finally {
                            saving.value = false;
                        }
                    }
                    
                    async function viewStaffDetails(staff) {
                        try {
                            const staffData = await api.getMedicalStaffById(staff.id);
                            staffDetailsModal.staff = staffData;
                            staffDetailsModal.activeTab = 'personal';
                            staffDetailsModal.show = true;
                        } catch (error) {
                            showToast('error', 'Load Failed', 'Failed to load staff details');
                        }
                    }
                    
                    function editMedicalStaff(staff) {
                        medicalStaffModal.mode = 'edit';
                        medicalStaffModal.form = { ...staff };
                        medicalStaffModal.activeTab = 'basic';
                        medicalStaffModal.show = true;
                    }
                    
                    function deleteMedicalStaff(id) {
                        showConfirmation({
                            title: 'Delete Medical Staff',
                            message: 'Are you sure you want to delete this medical staff record?',
                            details: 'This action cannot be undone.',
                            onConfirm: async () => {
                                try {
                                    await api.deleteMedicalStaff(id);
                                    medicalStaff.value = medicalStaff.value.filter(s => s.id !== id);
                                    showToast('success', 'Success', 'Medical staff deleted successfully');
                                } catch (error) {
                                    showToast('error', 'Delete Failed', error.message || 'Failed to delete medical staff');
                                }
                            }
                        });
                    }
                    
                    function showAddDepartmentModal() {
                        departmentModal.mode = 'add';
                        departmentModal.form = {
                            name: '',
                            code: '',
                            status: 'active',
                            head_of_department_id: null,
                            description: ''
                        };
                        departmentModal.show = true;
                    }
                    
                    async function saveDepartment() {
                        try {
                            saving.value = true;
                            
                            if (departmentModal.mode === 'add') {
                                const result = await api.createDepartment(departmentModal.form);
                                departments.value.push(result);
                                showToast('success', 'Success', 'Department added successfully');
                            } else {
                                const result = await api.updateDepartment(departmentModal.form.id, departmentModal.form);
                                const index = departments.value.findIndex(d => d.id === result.id);
                                if (index !== -1) {
                                    departments.value[index] = result;
                                }
                                showToast('success', 'Success', 'Department updated successfully');
                            }
                                                departmentModal.show = false;
                } catch (error) {
                    showToast('error', 'Save Failed', error.message || 'Failed to save department');
                } finally {
                    saving.value = false;
                }
            }
            
            function editDepartment(department) {
                departmentModal.mode = 'edit';
                departmentModal.form = { ...department };
                departmentModal.show = true;
            }
            
            function deleteDepartment(id) {
                showConfirmation({
                    title: 'Delete Department',
                    message: 'Are you sure you want to delete this department?',
                    details: 'All associated clinical units will also be removed.',
                    onConfirm: async () => {
                        try {
                            await api.deleteDepartment(id);
                            departments.value = departments.value.filter(d => d.id !== id);
                            clinicalUnits.value = clinicalUnits.value.filter(u => u.department_id !== id);
                            showToast('success', 'Success', 'Department deleted successfully');
                        } catch (error) {
                            showToast('error', 'Delete Failed', error.message || 'Failed to delete department');
                        }
                    }
                });
            }
            
            function showAddClinicalUnitModal() {
                clinicalUnitModal.mode = 'add';
                clinicalUnitModal.form = {
                    name: '',
                    code: '',
                    department_id: null,
                    unit_type: 'clinical',
                    status: 'active',
                    supervisor_id: null,
                    description: ''
                };
                clinicalUnitModal.show = true;
            }
            
            async function saveClinicalUnit() {
                try {
                    saving.value = true;
                    
                    if (clinicalUnitModal.mode === 'add') {
                        const result = await api.createClinicalUnit(clinicalUnitModal.form);
                        clinicalUnits.value.push(result);
                        showToast('success', 'Success', 'Clinical unit added successfully');
                    } else {
                        const result = await api.updateClinicalUnit(clinicalUnitModal.form.id, clinicalUnitModal.form);
                        const index = clinicalUnits.value.findIndex(u => u.id === result.id);
                        if (index !== -1) {
                            clinicalUnits.value[index] = result;
                        }
                        showToast('success', 'Success', 'Clinical unit updated successfully');
                    }
                    
                    clinicalUnitModal.show = false;
                } catch (error) {
                    showToast('error', 'Save Failed', error.message || 'Failed to save clinical unit');
                } finally {
                    saving.value = false;
                }
            }
            
            function editClinicalUnit(unit) {
                clinicalUnitModal.mode = 'edit';
                clinicalUnitModal.form = { ...unit };
                clinicalUnitModal.show = true;
            }
            
            function deleteClinicalUnit(id) {
                showConfirmation({
                    title: 'Delete Clinical Unit',
                    message: 'Are you sure you want to delete this clinical unit?',
                    onConfirm: async () => {
                        try {
                            await api.deleteClinicalUnit(id);
                            clinicalUnits.value = clinicalUnits.value.filter(u => u.id !== id);
                            showToast('success', 'Success', 'Clinical unit deleted successfully');
                        } catch (error) {
                            showToast('error', 'Delete Failed', error.message || 'Failed to delete clinical unit');
                        }
                    }
                });
            }
            
            function showAddTrainingUnitModal() {
                trainingUnitModal.mode = 'add';
                trainingUnitModal.form = {
                    name: '',
                    department_id: null,
                    supervisor_id: null,
                    max_capacity: 10,
                    status: 'active',
                    description: ''
                };
                trainingUnitModal.show = true;
            }
            
            async function saveTrainingUnit() {
                try {
                    saving.value = true;
                    
                    if (trainingUnitModal.mode === 'add') {
                        const result = await api.createTrainingUnit(trainingUnitModal.form);
                        trainingUnits.value.push(result);
                        showToast('success', 'Success', 'Training unit added successfully');
                    } else {
                        const result = await api.updateTrainingUnit(trainingUnitModal.form.id, trainingUnitModal.form);
                        const index = trainingUnits.value.findIndex(u => u.id === result.id);
                        if (index !== -1) {
                            trainingUnits.value[index] = result;
                        }
                        showToast('success', 'Success', 'Training unit updated successfully');
                    }
                    
                    trainingUnitModal.show = false;
                } catch (error) {
                    showToast('error', 'Save Failed', error.message || 'Failed to save training unit');
                } finally {
                    saving.value = false;
                }
            }
            
            function editTrainingUnit(unit) {
                trainingUnitModal.mode = 'edit';
                trainingUnitModal.form = { ...unit };
                trainingUnitModal.show = true;
            }
            
            function assignResidentToUnit(unit) {
                showQuickPlacementModal();
                quickPlacementModal.training_unit_id = unit.id;
            }
            
            function removeResidentFromUnit(residentId, unitId) {
                showConfirmation({
                    title: 'Remove Resident',
                    message: 'Are you sure you want to remove this resident from the training unit?',
                    onConfirm: async () => {
                        try {
                            // Find and update the rotation
                            const rotation = rotations.value.find(r => 
                                r.resident_id === residentId && 
                                r.training_unit_id === unitId &&
                                r.status === 'active'
                            );
                            
                            if (rotation) {
                                await api.updateRotation(rotation.id, { ...rotation, status: 'cancelled' });
                                rotations.value = rotations.value.filter(r => r.id !== rotation.id);
                                
                                // Update unit resident count
                                const unit = trainingUnits.value.find(u => u.id === unitId);
                                if (unit) {
                                    unit.current_residents = Math.max(0, unit.current_residents - 1);
                                }
                                
                                showToast('success', 'Success', 'Resident removed from training unit');
                            }
                        } catch (error) {
                            showToast('error', 'Remove Failed', error.message || 'Failed to remove resident');
                        }
                    }
                });
            }
            
            function showAddRotationModal() {
                rotationModal.mode = 'add';
                rotationModal.form = {
                    resident_id: null,
                    training_unit_id: null,
                    start_date: new Date().toISOString().split('T')[0],
                    end_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    supervisor_id: null,
                    status: 'active',
                    goals: '',
                    notes: ''
                };
                rotationModal.show = true;
            }
            
            async function saveRotation() {
                try {
                    saving.value = true;
                    
                    if (rotationModal.mode === 'add') {
                        const result = await api.createRotation(rotationModal.form);
                        rotations.value.push(result);
                        
                        // Update unit resident count
                        const unit = trainingUnits.value.find(u => u.id === result.training_unit_id);
                        if (unit) {
                            unit.current_residents = (unit.current_residents || 0) + 1;
                        }
                        
                        showToast('success', 'Success', 'Rotation added successfully');
                    } else {
                        const result = await api.updateRotation(rotationModal.form.id, rotationModal.form);
                        const index = rotations.value.findIndex(r => r.id === result.id);
                        if (index !== -1) {
                            rotations.value[index] = result;
                        }
                        showToast('success', 'Success', 'Rotation updated successfully');
                    }
                    
                    rotationModal.show = false;
                } catch (error) {
                    showToast('error', 'Save Failed', error.message || 'Failed to save rotation');
                } finally {
                    saving.value = false;
                }
            }
            
            function editRotation(rotation) {
                rotationModal.mode = 'edit';
                rotationModal.form = { ...rotation };
                rotationModal.show = true;
            }
            
            function deleteRotation(id) {
                showConfirmation({
                    title: 'Delete Rotation',
                    message: 'Are you sure you want to delete this rotation?',
                    onConfirm: async () => {
                        try {
                            const rotation = rotations.value.find(r => r.id === id);
                            await api.deleteRotation(id);
                            rotations.value = rotations.value.filter(r => r.id !== id);
                            
                            // Update unit resident count
                            if (rotation) {
                                const unit = trainingUnits.value.find(u => u.id === rotation.training_unit_id);
                                if (unit && unit.current_residents > 0) {
                                    unit.current_residents -= 1;
                                }
                            }
                            
                            showToast('success', 'Success', 'Rotation deleted successfully');
                        } catch (error) {
                            showToast('error', 'Delete Failed', error.message || 'Failed to delete rotation');
                        }
                    }
                });
            }
            
            function assignRotationToStaff(staff) {
                if (staff.staff_type === 'medical_resident') {
                    rotationModal.mode = 'add';
                    rotationModal.form.resident_id = staff.id;
                    rotationModal.show = true;
                }
            }
            
            function showAddOnCallModal() {
                onCallModal.mode = 'add';
                onCallModal.form = {
                    duty_date: new Date().toISOString().split('T')[0],
                    shift_type: 'primary_call',
                    start_time: '08:00',
                    end_time: '20:00',
                    primary_physician_id: null,
                    backup_physician_id: null,
                    coverage_notes: ''
                };
                onCallModal.show = true;
            }
            
            async function saveOnCallSchedule() {
                try {
                    saving.value = true;
                    
                    if (onCallModal.mode === 'add') {
                        const result = await api.createOnCallSchedule(onCallModal.form);
                        onCallSchedule.value.push(result);
                        showToast('success', 'Success', 'On-call schedule added successfully');
                    } else {
                        const result = await api.updateOnCallSchedule(onCallModal.form.id, onCallModal.form);
                        const index = onCallSchedule.value.findIndex(s => s.id === result.id);
                        if (index !== -1) {
                            onCallSchedule.value[index] = result;
                        }
                        showToast('success', 'Success', 'On-call schedule updated successfully');
                    }
                    
                    onCallModal.show = false;
                } catch (error) {
                    showToast('error', 'Save Failed', error.message || 'Failed to save on-call schedule');
                } finally {
                    saving.value = false;
                }
            }
            
            function editOnCallSchedule(schedule) {
                onCallModal.mode = 'edit';
                onCallModal.form = { ...schedule };
                onCallModal.show = true;
            }
            
            function deleteOnCallSchedule(id) {
                showConfirmation({
                    title: 'Delete Schedule',
                    message: 'Are you sure you want to delete this on-call schedule?',
                    onConfirm: async () => {
                        try {
                            await api.deleteOnCallSchedule(id);
                            onCallSchedule.value = onCallSchedule.value.filter(s => s.id !== id);
                            showToast('success', 'Success', 'On-call schedule deleted successfully');
                        } catch (error) {
                            showToast('error', 'Delete Failed', error.message || 'Failed to delete schedule');
                        }
                    }
                });
            }
            
            function showAddAbsenceModal() {
                absenceModal.mode = 'add';
                absenceModal.form = {
                    staff_member_id: null,
                    absence_reason: '',
                    start_date: new Date().toISOString().split('T')[0],
                    end_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    notes: '',
                    replacement_staff_id: null,
                    coverage_instructions: ''
                };
                absenceModal.show = true;
            }
            
            async function saveAbsence() {
                try {
                    saving.value = true;
                    
                    if (absenceModal.mode === 'add') {
                        const result = await api.createAbsence(absenceModal.form);
                        absences.value.push(result);
                        showToast('success', 'Success', 'Absence documented successfully');
                    } else {
                        const result = await api.updateAbsence(absenceModal.form.id, absenceModal.form);
                        const index = absences.value.findIndex(a => a.id === result.id);
                        if (index !== -1) {
                            absences.value[index] = result;
                        }
                        showToast('success', 'Success', 'Absence updated successfully');
                    }
                    
                    absenceModal.show = false;
                } catch (error) {
                    showToast('error', 'Save Failed', error.message || 'Failed to save absence');
                } finally {
                    saving.value = false;
                }
            }
            
            function editAbsence(absence) {
                absenceModal.mode = 'edit';
                absenceModal.form = { ...absence };
                absenceModal.show = true;
            }
            
            async function viewAbsenceDetails(absence) {
                try {
                    const absenceData = await api.getAbsenceById(absence.id);
                    absenceDetailsModal.absence = absenceData;
                    absenceDetailsModal.activeTab = 'details';
                    absenceDetailsModal.show = true;
                } catch (error) {
                    showToast('error', 'Load Failed', 'Failed to load absence details');
                }
            }
            
            function assignCoverage(absence) {
                absenceModal.mode = 'edit';
                absenceModal.form = { ...absence };
                absenceModal.form.replacement_staff_id = '';
                absenceModal.show = true;
            }
            
            function deleteAbsence(id) {
                showConfirmation({
                    title: 'Delete Absence Record',
                    message: 'Are you sure you want to delete this absence record?',
                    onConfirm: async () => {
                        try {
                            await api.deleteAbsence(id);
                            absences.value = absences.value.filter(a => a.id !== id);
                            showToast('success', 'Success', 'Absence record deleted successfully');
                        } catch (error) {
                            showToast('error', 'Delete Failed', error.message || 'Failed to delete absence');
                        }
                    }
                });
            }
            
            function showQuickPlacementModal() {
                quickPlacementModal.resident_id = null;
                quickPlacementModal.training_unit_id = null;
                quickPlacementModal.start_date = new Date().toISOString().split('T')[0];
                quickPlacementModal.duration = 4;
                quickPlacementModal.supervisor_id = null;
                quickPlacementModal.notes = '';
                quickPlacementModal.show = true;
            }
            
            async function saveQuickPlacement() {
                try {
                    saving.value = true;
                    
                    const endDate = new Date(quickPlacementModal.start_date);
                    endDate.setDate(endDate.getDate() + (quickPlacementModal.duration * 7));
                    
                    const rotationData = {
                        resident_id: quickPlacementModal.resident_id,
                        training_unit_id: quickPlacementModal.training_unit_id,
                        start_date: quickPlacementModal.start_date,
                        end_date: endDate.toISOString().split('T')[0],
                        supervisor_id: quickPlacementModal.supervisor_id,
                        status: 'active',
                        notes: quickPlacementModal.notes
                    };
                    
                    const result = await api.createQuickPlacement(rotationData);
                    rotations.value.push(result);
                    
                    // Update unit resident count
                    const unit = trainingUnits.value.find(u => u.id === result.training_unit_id);
                    if (unit) {
                        unit.current_residents = (unit.current_residents || 0) + 1;
                    }
                    
                    showToast('success', 'Success', 'Resident placed successfully');
                    quickPlacementModal.show = false;
                } catch (error) {
                    showToast('error', 'Placement Failed', error.message || 'Failed to place resident');
                } finally {
                    saving.value = false;
                }
            }
            
            function showBulkAssignModal() {
                bulkAssignModal.selectedResidents = [];
                bulkAssignModal.training_unit_id = null;
                bulkAssignModal.start_date = new Date().toISOString().split('T')[0];
                bulkAssignModal.duration = 4;
                bulkAssignModal.supervisor_id = null;
                bulkAssignModal.show = true;
            }
            
            async function saveBulkAssignment() {
                try {
                    saving.value = true;
                    
                    const assignmentData = {
                        resident_ids: bulkAssignModal.selectedResidents,
                        training_unit_id: bulkAssignModal.training_unit_id,
                        start_date: bulkAssignModal.start_date,
                        duration: bulkAssignModal.duration,
                        supervisor_id: bulkAssignModal.supervisor_id
                    };
                    
                    const results = await api.createBulkAssignment(assignmentData);
                    rotations.value.push(...results);
                    
                    // Update unit resident count
                    const unit = trainingUnits.value.find(u => u.id === bulkAssignModal.training_unit_id);
                    if (unit) {
                        unit.current_residents = (unit.current_residents || 0) + results.length;
                    }
                    
                    showToast('success', 'Success', `${results.length} residents assigned successfully`);
                    bulkAssignModal.show = false;
                } catch (error) {
                    showToast('error', 'Assignment Failed', error.message || 'Failed to assign residents');
                } finally {
                    saving.value = false;
                }
            }
            
            function showCommunicationsModal() {
                communicationsModal.activeTab = 'announcement';
                communicationsModal.show = true;
            }
            
            function getCommunicationIcon(tab) {
                const icons = {
                    'announcement': 'fa-bullhorn',
                    'capacity': 'fa-bed',
                    'quick': 'fa-comment-medical'
                };
                return icons[tab] || 'fa-bullhorn';
            }
            
            function getCommunicationButtonText(tab) {
                const texts = {
                    'announcement': 'Post Announcement',
                    'capacity': 'Update Capacity',
                    'quick': 'Post Update'
                };
                return texts[tab] || 'Post';
            }
            
            async function saveCommunication() {
                try {
                    saving.value = true;
                    
                    if (communicationsModal.activeTab === 'announcement') {
                        const result = await api.createAnnouncement(communicationsModal.form);
                        recentAnnouncements.value.unshift(result);
                        showToast('success', 'Success', 'Announcement posted successfully');
                    } else if (communicationsModal.activeTab === 'capacity') {
                        const result = await api.updateCapacity(communicationsModal.capacity);
                        currentCapacity.er = { ...result.er };
                        currentCapacity.icu = { ...result.icu };
                        showToast('success', 'Success', 'Capacity updated successfully');
                    } else if (communicationsModal.activeTab === 'quick') {
                        // Handle quick update
                        showToast('success', 'Success', 'Quick update posted successfully');
                    }
                    
                    communicationsModal.show = false;
                } catch (error) {
                    showToast('error', 'Save Failed', error.message || 'Failed to save communication');
                } finally {
                    saving.value = false;
                }
            }
            
            function updateCapacity() {
                // Update capacity status based on current values
                currentCapacity.er.status = getCapacityStatus(currentCapacity.er);
                currentCapacity.icu.status = getCapacityStatus(currentCapacity.icu);
                
                showToast('success', 'Success', 'Capacity updated successfully');
            }
            
            function showAddRoleModal() {
                roleModal.mode = 'add';
                roleModal.form = {
                    name: '',
                    description: '',
                    permissions: []
                };
                roleModal.show = true;
            }
            
            async function saveRole() {
                try {
                    saving.value = true;
                    // Implementation for saving role
                    showToast('success', 'Success', 'Role saved successfully');
                    roleModal.show = false;
                } catch (error) {
                    showToast('error', 'Save Failed', error.message || 'Failed to save role');
                } finally {
                    saving.value = false;
                }
            }
            
            function editRole(role) {
                roleModal.mode = 'edit';
                roleModal.form = { ...role };
                roleModal.show = true;
            }
            
            function deleteRole(id) {
                showConfirmation({
                    title: 'Delete Role',
                    message: 'Are you sure you want to delete this role?',
                    details: 'Users with this role will need to be reassigned.',
                    onConfirm: async () => {
                        showToast('success', 'Success', 'Role deleted successfully');
                    }
                });
            }
            
            function toggleRolePermission(roleId, permissionId) {
                // Toggle permission for role
                const role = userRoles.value.find(r => r.id === roleId);
                if (role) {
                    if (!role.permissions) role.permissions = [];
                    const index = role.permissions.indexOf(permissionId);
                    if (index === -1) {
                        role.permissions.push(permissionId);
                    } else {
                        role.permissions.splice(index, 1);
                    }
                }
            }
            
            function editUserPermissions(user) {
                showToast('info', 'Coming Soon', 'User permission editing will be available in the next update');
            }
            
            function showUserProfile() {
                userProfileModal.form = {
                    full_name: currentUser.value.full_name,
                    email: currentUser.value.email,
                    phone: currentUser.value.phone || '',
                    department_id: currentUser.value.department_id,
                    notifications_enabled: true,
                    absence_notifications: true,
                    announcement_notifications: true
                };
                userProfileModal.show = true;
            }
            
            async function saveUserProfile() {
                try {
                    saving.value = true;
                    // Implementation for saving user profile
                    showToast('success', 'Success', 'Profile updated successfully');
                    userProfileModal.show = false;
                } catch (error) {
                    showToast('error', 'Save Failed', error.message || 'Failed to save profile');
                } finally {
                    saving.value = false;
                }
            }
            
            function showSystemSettingsModal() {
                switchView('system_settings');
            }
            
            function showPermissionManager() {
                switchView('permission_manager');
            }
            
            async function saveSystemSettings() {
                try {
                    saving.value = true;
                    await api.updateSystemSettings(systemSettings);
                    showToast('success', 'Success', 'System settings saved successfully');
                } catch (error) {
                    showToast('error', 'Save Failed', error.message || 'Failed to save settings');
                } finally {
                    saving.value = false;
                }
            }
            
            function exportAuditLogs() {
                showToast('info', 'Coming Soon', 'Export functionality will be available in the next update');
            }
            
            function dismissAlert(alertId) {
                activeAlerts.value = activeAlerts.value.filter(alert => alert.id !== alertId);
            }
            
            function toggleStatsSidebar() {
                statsSidebarOpen.value = !statsSidebarOpen.value;
            }
            
            function toggleSearchScope() {
                const scopes = ['Global', 'Staff', 'Patients', 'Units', 'Departments'];
                const currentIndex = scopes.indexOf(searchScope.value);
                searchScope.value = scopes[(currentIndex + 1) % scopes.length];
            }
            
            function setSearchFilter(filter) {
                searchFilter.value = filter;
            }
            
            function handleSearch() {
                if (!searchQuery.value.trim()) return;
                
                showToast('info', 'Search Results', `Searching for "${searchQuery.value}" in ${searchScope.value} (${searchFilter.value})`);
                // Implementation would search based on current view
            }
            
            function resetStaffFilters() {
                staffSearch.value = '';
                staffFilter.staff_type = '';
                staffFilter.employment_status = '';
            }
            
            function applyStaffFilters() {
                // Filters are applied automatically via computed property
            }
            
            function resetRotationFilters() {
                rotationFilter.resident_id = '';
                rotationFilter.status = '';
                rotationFilter.training_unit_id = '';
            }
            
            function applyRotationFilters() {
                // Filters are applied automatically via computed property
            }
            
            function resetAbsenceFilters() {
                absenceFilter.staff_id = '';
                absenceFilter.status = '';
                absenceFilter.start_date = '';
            }
            
            function applyAbsenceFilters() {
                // Filters are applied automatically via computed property
            }
            
            function resetAuditFilters() {
                auditFilters.dateRange = '';
                auditFilters.actionType = '';
                auditFilters.userId = '';
            }
            
            function applyAuditFilters() {
                // Filters are applied automatically via computed property
            }
            
            function showAbsenceCalendar(view) {
                showToast('info', 'Calendar View', `Showing absence calendar in ${view} view`);
            }
            
            function getAbsenceTimelineStatus(absence) {
                const today = new Date();
                const startDate = new Date(absence.start_date);
                const endDate = new Date(absence.end_date);
                
                if (today < startDate) {
                    return `Starts in ${Math.ceil((startDate - today) / (1000 * 60 * 60 * 24))} days`;
                } else if (today > endDate) {
                    return 'Completed';
                } else {
                    return `In progress - Day ${Math.ceil((today - startDate) / (1000 * 60 * 60 * 24)) + 1}`;
                }
            }
            
            function formatApprovalStatus(status) {
                const statuses = {
                    'pending': 'Pending',
                    'approved': 'Approved',
                    'rejected': 'Rejected',
                    'auto_approved': 'Auto-Approved'
                };
                return statuses[status] || status;
            }
            
            function getApprovalStatusClass(status) {
                const classes = {
                    'pending': 'badge-warning',
                    'approved': 'badge-success',
                    'rejected': 'badge-danger',
                    'auto_approved': 'badge-info'
                };
                return classes[status] || 'badge-info';
            }
            
            function showNotifications() {
                showToast('info', 'Notifications', `${unreadNotifications.value} unread notifications`);
                unreadNotifications.value = 0;
            }
            
            // ============ INITIALIZATION ============
            onMounted(async () => {
                // Check for remembered email
                const rememberedEmail = localStorage.getItem('rememberedEmail');
                if (rememberedEmail) {
                    loginForm.email = rememberedEmail;
                    loginForm.remember_me = true;
                }
                
                // Check for existing auth token
                const token = localStorage.getItem('authToken');
                if (token) {
                    try {
                        authToken = token;
                        // Try to get current user info
                        currentUser.value = { 
                            full_name: 'System Administrator',
                            user_role: 'system_admin',
                            email: 'admin@neumocare.org'
                        };
                        loadDashboardData();
                    } catch (error) {
                        localStorage.removeItem('authToken');
                    }
                }
                
                // Set up auto-refresh for live stats
                setInterval(async () => {
                    if (currentUser.value && currentView.value === 'daily_operations') {
                        try {
                            const liveData = await api.getLiveStats();
                            Object.assign(liveStats, liveData);
                        } catch (error) {
                            console.error('Error refreshing live stats:', error);
                        }
                    }
                }, 30000); // Every 30 seconds
                
                // Mock data for demonstration
                if (!currentUser.value) return;
                
                // Initialize with mock data for demo
                setTimeout(() => {
                    activeAlerts.value = [
                        { id: 1, message: 'Pulmo ICU at 85% capacity', type: 'warning' },
                        { id: 2, message: 'Dr. Smith on vacation next week', type: 'info' }
                    ];
                    
                    unreadNotifications.value = 3;
                }, 1000);
            });
            
            // ============ EXPOSE TO TEMPLATE ============
            return {
                // State
                currentUser,
                loading,
                saving,
                currentView,
                sidebarCollapsed,
                mobileMenuOpen,
                statsSidebarOpen,
                userMenuOpen,
                
                // Data
                medicalStaff,
                departments,
                clinicalUnits,
                trainingUnits,
                rotations,
                onCallSchedule,
                absences,
                recentAnnouncements,
                auditLogs,
                users,
                userRoles,
                availablePermissions,
                stats,
                liveStats,
                todaysOnCall,
                loadingStats,
                loadingSchedule,
                loadingStaff,
                loadingAnnouncements,
                systemSettings,
                
                // Forms
                loginForm,
                medicalStaffModal,
                staffDetailsModal,
                departmentModal,
                clinicalUnitModal,
                trainingUnitModal,
                rotationModal,
                rotationDetailsModal,
                onCallModal,
                absenceModal,
                absenceDetailsModal,
                quickPlacementModal,
                bulkAssignModal,
                communicationsModal,
                roleModal,
                userProfileModal,
                confirmationModal,
                
                // UI
                toasts,
                searchQuery,
                searchScope,
                searchFilter,
                staffSearch,
                staffFilter,
                rotationFilter,
                absenceFilter,
                auditFilters,
                activeAlerts,
                unreadNotifications,
                currentCapacity,
                
                // Computed
                filteredMedicalStaff,
                filteredRotations,
                filteredAbsences,
                filteredAuditLogs,
                availableHeadsOfDepartment,
                availableSupervisors,
                availableAttendings,
                availablePhysicians,
                availableResidents,
                availableStaff,
                availableCoverageStaff,
                availableTrainingUnits,
                residents,
                
                // Methods
                // Helper functions
                getInitials,
                formatDateTime,
                formatDate,
                formatTimeAgo,
                formatStaffType,
                getStaffTypeClass,
                formatEmploymentStatus,
                getDepartmentName,
                getDepartmentUnits,
                formatTrainingLevel,
                formatResidentCategory,
                getResidentName,
                getTrainingUnitName,
                getSupervisorName,
                formatRotationStatus,
                getRotationStatusClass,
                getUnitResidents,
                formatAbsenceReason,
                calculateAbsenceDuration,
                getAbsenceStatusClass,
                formatAbsenceStatus,
                getStaffName,
                formatAuditAction,
                getUserName,
                formatPermissionName,
                roleHasPermission,
                getUserPermissions,
                getUserRoleDisplay,
                hasPermission,
                getCurrentTitle,
                getCurrentSubtitle,
                getSearchPlaceholder,
                getPriorityColor,
                getCapacityStatus,
                formatTimeRange,
                
                // Toast functions
                showToast,
                removeToast,
                
                // Confirmation modal
                showConfirmation,
                cancelConfirmation,
                confirmAction,
                
                // Action menu
                toggleActionMenu,
                toggleUserMenu,
                
                // View switching
                switchView,
                
                // Authentication
                handleLogin,
                handleLogout,
                
                // Modal functions
                showAddMedicalStaffModal,
                saveMedicalStaff,
                viewStaffDetails,
                editMedicalStaff,
                deleteMedicalStaff,
                showAddDepartmentModal,
                saveDepartment,
                editDepartment,
                deleteDepartment,
                showAddClinicalUnitModal,
                saveClinicalUnit,
                editClinicalUnit,
                deleteClinicalUnit,
                showAddTrainingUnitModal,
                saveTrainingUnit,
                editTrainingUnit,
                assignResidentToUnit,
                removeResidentFromUnit,
                showAddRotationModal,
                saveRotation,
                editRotation,
                deleteRotation,
                assignRotationToStaff,
                showAddOnCallModal,
                saveOnCallSchedule,
                editOnCallSchedule,
                deleteOnCallSchedule,
                showAddAbsenceModal,
                saveAbsence,
                editAbsence,
                viewAbsenceDetails,
                assignCoverage,
                deleteAbsence,
                showQuickPlacementModal,
                saveQuickPlacement,
                showBulkAssignModal,
                saveBulkAssignment,
                showCommunicationsModal,
                getCommunicationIcon,
                getCommunicationButtonText,
                saveCommunication,
                updateCapacity,
                showAddRoleModal,
                saveRole,
                editRole,
                deleteRole,
                toggleRolePermission,
                editUserPermissions,
                showUserProfile,
                saveUserProfile,
                showSystemSettingsModal,
                showPermissionManager,
                saveSystemSettings,
                exportAuditLogs,
                dismissAlert,
                toggleStatsSidebar,
                toggleSearchScope,
                setSearchFilter,
                handleSearch,
                resetStaffFilters,
                applyStaffFilters,
                resetRotationFilters,
                applyRotationFilters,
                resetAbsenceFilters,
                applyAbsenceFilters,
                resetAuditFilters,
                applyAuditFilters,
                showAbsenceCalendar,
                getAbsenceTimelineStatus,
                formatApprovalStatus,
                getApprovalStatusClass,
                showNotifications
            };
        }
    }).mount('#app');
</script>
</body>
</html>                       
